"use strict";gambio.widgets.module("cart_handler",["form","xhr",gambio.source+"/libs/events",gambio.source+"/libs/modal.ext-magnific",gambio.source+"/libs/modal"],function(e){var t=$(this),a=$("body"),s=$(window),r=!1,i=null,n=0,o={addCartUrl:"shop.php?do=Cart/BuyProduct",addCartCustomizerUrl:"shop.php?do=Cart/Add",checkUrl:"shop.php?do=CheckStatus",wishlistUrl:"shop.php?do=WishList/Add",priceOfferUrl:"gm_price_offer.php",priceOfferMethod:"get",dropdown:"#head_shopping_cart",cartButtons:".js-btn-add-to-cart",wishlistButtons:".btn-wishlist",priceOfferButtons:".btn-price-offer",attributes:".js-calculate",quantity:".js-calculate-qty",tpl:null,attributImagesSwiper:!1,triggerAttrImagesTo:"#product_image_swiper, #product_thumbnail_swiper, #product_thumbnail_swiper_mobile",processingClass:"loading",processingDuration:2e3,selectorMapping:{attributeImages:".attribute-images",buttons:".shopping-cart-button",giftContent:".gift-cart-content-wrapper",giftLayer:".gift-cart-layer",shareContent:".share-cart-content-wrapper",shareLayer:".share-cart-layer",hiddenOptions:"#cart_quantity .hidden-options",message:".global-error-messages",messageCart:".cart-error-msg",messageHelp:".help-block",modelNumber:".model-number",price:".current-price-container",propertiesForm:".properties-selection-form",quantity:".products-quantity-value",ribbonSpecial:".ribbon-special",shippingInformation:"#shipping-information-layer",shippingTime:".products-shipping-time-value",shippingTimeImage:".img-shipping-time img",totals:"#cart_quantity .total-box",weight:".products-details-weight-container span"}},c=$.extend(!0,{},o,e),l={},u=function(e,t){var a=setTimeout(function(){e.removeClass(c.processingClass+" "+c.processingClass+t)},c.processingDuration);e.data("timer",a).addClass(c.processingClass+t)},d=function(e,t,a,r){if(c.attributImagesSwiper&&e.attrImages&&e.attrImages.length&&(delete e.content.images,$(c.triggerAttrImagesTo).trigger(jse.libs.template.events.SLIDES_UPDATE(),{attributes:e.attrImages})),$.each(e.content,function(e,a){var s=t.parent().find(c.selectorMapping[a.selector]);if((!r||""===a.value)&&"messageNoCombiSelected"===e)return!0;switch(a.type){case"html":s.html(a.value);break;case"attribute":s.attr(a.key,a.value);break;case"replace":a.value?s.replaceWith(a.value):s.addClass("hidden").empty();break;default:s.text(a.value)}}),a){var i=t.find(c.cartButtons);e.success?i.removeClass("inactive"):i.addClass("inactive")}if(e.content.message){var n=t.find(c.selectorMapping[e.content.message.selector]);e.content.message.value?n.removeClass("hidden").show():(n.addClass("hidden").hide(),r&&void 0!==e.content.messageNoCombiSelected&&e.content.messageNoCombiSelected&&(e.content.messageNoCombiSelected.value?n.removeClass("hidden").show():n.addClass("hidden").hide()))}s.trigger(jse.libs.template.events.STICKYBOX_CONTENT_CHANGE())},p=function(e,t,s,i){r||(r=!0,jse.libs.xhr.post({url:s,data:e},!0).done(function(e){try{if(d(e,t,!1),e.success)switch(e.type){case"url":"http"!==e.url.substr(0,4)?location.href=jse.core.config.get("appUrl")+"/"+e.url:location.href=e.url;break;case"dropdown":a.trigger(jse.libs.template.events.CART_UPDATE(),[!0]);break;case"layer":jse.libs.template.modal.info({title:e.title,content:e.msg})}}catch(s){}u(i,"-success")}).fail(function(){u(i,"-fail")}).always(function(){r=!1}))},g=function(e){e&&e.preventDefault();var r=$(this),n=r.is("form")?r:r.closest("form"),o=n.hasClass("customizer"),l=!!n.find(".properties-selection-form").length,g=l?"":"/Attributes",m=e&&e.data&&e.data.target&&"check"!==e.data.target;if(n.length){l&&t.addClass("loading");var h=jse.libs.form.getData(n,null,!0);if(h.target=e&&e.data&&e.data.target?e.data.target:"check",i&&e&&i.abort(),"check"!==h.target){var f=r.data("timer");f&&clearTimeout(f),r.removeClass(c.processingClass+"-success "+c.processingClass+"-fail").addClass(c.processingClass)}i=jse.libs.xhr.get({url:c.checkUrl+g,data:h},!0).done(function(e){if(d(e,n,!0,m),t.removeClass("loading"),e.success){var i=null,l=null;switch(h.target){case"wishlist":o&&(i=jse.libs.template.events.ADD_CUSTOMIZER_WISHLIST()),l=c.wishlistUrl;break;case"cart":o?(i=jse.libs.template.events.ADD_CUSTOMIZER_CART(),l=c.addCartCustomizerUrl):l=c.addCartUrl;break;case"price_offer":return n.attr("action",c.priceOfferUrl).attr("method",c.priceOfferMethod),n.off("submit"),void n.submit();default:setTimeout(function(){s.trigger(jse.libs.template.events.STICKYBOX_CONTENT_CHANGE())},250)}if(i){var g=$.Deferred();g.done(function(e){h[e]=0,p(h,n,l,r)}).fail(function(){u(r,"-fail")}),a.trigger(i,[{deferred:g,dataset:h}])}else l&&p(h,n,l,r)}}).fail(function(){u(r,"-fail")})}},m=function(e){clearTimeout(n),n=setTimeout(function(){g.call(this,e)}.bind(this),300)};return l.init=function(e){var a=t.find("form");a.on("submit",{target:"cart"},g).on("click",c.cartButtons+":not(.inactive)",{target:"cart"},g).on("click",c.wishlistButtons,{target:"wishlist"},g).on("click",c.priceOfferButtons,{target:"price_offer"},g).on("change",c.attributes,{target:"check"},g).on("blur",c.quantity,{target:"check"},g).on("keyup",c.quantity,{target:"check"},m),a.not(".no-status-check").each(function(){g.call($(this))}),e()},l});