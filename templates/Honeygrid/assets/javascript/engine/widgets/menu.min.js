"use strict";gambio.widgets.module("menu",[gambio.source+"/libs/events",gambio.source+"/libs/responsive",gambio.source+"/libs/interaction"],function(e){var t=$(this),n=$(window),a=$("body"),i=null,o=null,s=null,l=null,r=null,c=null,u=null,d=null,v=null,f=null,p=!1,h=null,m=null,b=!1,g=!1,C=null,T=null,w={},y=Modernizr.touchevents||navigator.userAgent.search(/Touch/i)!==-1,I={menuType:"horizontal",unfoldLevel:0,accordion:!1,showAllLink:!1,breakpoint:40,enterDelay:0,leaveDelay:50,widthTolerance:10,openClass:"open",switchElementPosition:!0,ignoreClass:"ignore-menu",touchMoveTolerance:10,openActive:!1,events:{desktop:["touch","hover"],mobile:["touch","click"]}},N=$.extend({},I,e),k={},O=function(){T=T||C;var e=Math.abs(T.event.originalEvent.pageY-C.event.originalEvent.pageY);return T=null,e>N.touchMoveTolerance},D=function(){i=t.children("ul"),o=i.children().not(".navbar-topbar-item"),s=o.filter(".dropdown-more"),l=s.children("ul"),c=o.filter(".custom"),r=o.not(s),u=r.not(c)},E=function(e,t){var n=e.data("position"),a=!1;t.children().each(function(){var t=$(this),i=t.data("position");if(i>n)return t.before(e.detach()),a=!0,!1}),a||t.append(e)},j=function(e){var t=!1,n=function(n){n.each(function(){var n=$(this),a=n.data().width;return e>a?(E(n,i),void(e-=a)):(t=!0,!1)})};D(),n(l.children(".custom")),t||n(l.children());var a=0;l.children().each(function(){a+=$(this).data().width}),0===a?s.hide():a<s.data().width+e&&(s.hide(),e+=s.data().width,n(l.children()))},S=function(e){var t=!1,n=function(n){n.each(function(){var n=$(this),a=n.data().width;if(n.filter("."+N.openClass).add(n.find("."+N.openClass)).removeClass(N.openClass),E(n,l),e-=a,e<0)return t=!0,!1})};D(),s.is(":hidden")&&(e+=s.data().width,s.removeClass("style"),s.show()),n($(u.get().reverse())),t||n($(c.get().reverse()))},A=function(){o.each(function(e){var t=$(this),n=t.outerWidth();t.data({width:n,position:e})})},P=function(){t.find("li."+N.openClass).each(function(){return $(this).parents(".navbar-categories-left").length>0||void $(this).removeClass(N.openClass)})},R=function(){h=h?clearTimeout(h):null,m=m?clearTimeout(m):null},_=function(){t.css({overflow:"visible",height:"auto"})},M=function(){var e=i.width(),t=o.filter("."+N.openClass).children("ul");t.each(function(){var t=$(this),n=t.parent();n.removeClass("flyout-right flyout-left flyout-center flyout-wont-fit");var a=t.outerWidth(),i=n.position().left,o=n.outerWidth();e>i+a?n.addClass("flyout-right"):i+o-a>0?n.addClass("flyout-left"):a<e?n.addClass("flyout-center"):n.addClass("flyout-wont-fit")})},U=function(e,n){var a=t.innerWidth()-N.widthTolerance,o=0;"horizontal"!==N.menuType||v===a&&"switchedToDesktop"!==n||(i.children(":visible").each(function(){o+=$(this).data("width")}),a<o?S(o-a):j(a-o),M(),v=a)},z=function(){v=-1,j(99999999),"vertical"===N.menuType&&($("#categories nav.navbar-default:first").not(".nav-categories-left").length>0&&$("#categories nav.navbar-default:first").css({opacity:0,height:0}).children().hide(),t.find("ul.level-1 li.navbar-topbar-item:first").before($("#categories nav.navbar-default li.topmenu-content").detach()),t.appendTo("#categories > .navbar-collapse"),t.addClass("navbar-default navbar-categories"),t.find("ul.level-1").addClass("navbar-nav"),t.find(".navbar-topbar-item").not(".topbar-search").show(),G(),a.trigger(jse.libs.template.events.MENU_REPOSITIONED(),["switchedToMobile"]))},F=function(){if("vertical"===N.menuType){$("#categories nav.navbar-default:first").not(".nav-categories-left").length>0&&$("#categories nav.navbar-default:first").css({opacity:1,height:"auto"}).children().show();var e=t.find("li.topmenu-content").detach();$("#categories nav.navbar-default ul.level-1:first").append(e),t.appendTo(".box-categories"),t.removeClass("navbar-default navbar-categories"),t.find("ul.level-1").removeClass("navbar-nav"),t.find(".navbar-topbar-item").hide(),J(),a.trigger(jse.libs.template.events.MENU_REPOSITIONED(),["switchedToDesktop"])}b||(A(),b=!0),"horizontal"===N.menuType&&(U(),y&&(i.find(".enter-category").show(),i.find(".dropdown > a").click(function(e){e.preventDefault()})))},H=function(e,t){e.removeClass("touch mouse").addClass(t||"")},L=function(){var e=f||{},t=jse.libs.template.responsive.breakpoint();if(t.id!==e.id){var n=t.id<=N.breakpoint&&(!p||void 0===e.id),a=t.id>N.breakpoint&&(p||void 0===e.id);p=t.id<=N.breakpoint,f=$.extend({},t),n||a?(R(),"vertical"!==N.menuType&&P(),N.switchElementPosition?n?z():F():M()):!p&&N.switchElementPosition?U():p||M()}},W=function(e,n,a){var o=$(this),s=o.children("ul"),l=s.length,r=s.length?s.data("level")||"0":99,c=parseInt(r,10)<=2&&f.id>N.breakpoint||f.id<=N.breakpoint;if("mobile"===n&&e.stopPropagation(),l&&c)if(e.preventDefault(),"mobile"===n)o.toggleClass(N.openClass);else{var u=o.hasClass(N.openClass),d=o.hasClass("leave"),v=e.data&&e.data.action?e.data.action:u&&d?"enter":u?"leave":"enter";switch(v){case"enter":g||jse.libs.template.interaction.isMouseDown()||(g=!0,R(),h=setTimeout(function(){i.find("."+N.openClass).not(o).not(o.parentsUntil(t,"."+N.openClass)).trigger(jse.libs.template.events.TRANSITION_STOP(),[]).removeClass(N.openClass),i.find(".leave").trigger(jse.libs.template.events.TRANSITION_STOP(),[]).removeClass("leave"),w.open=!0,o.off(jse.libs.template.events.TRANSITION_FINISHED()).one(jse.libs.template.events.TRANSITION_FINISHED(),function(){g=!1}).trigger(jse.libs.template.events.TRANSITION(),w).trigger(jse.libs.template.events.OPEN_FLYOUT(),[t]),M()},"number"==typeof a?a:N.enterDelay));break;case"leave":g=!1,R(),o.addClass("leave"),m=setTimeout(function(){w.open=!1,i.find("."+N.openClass).not(o.parentsUntil(t,"."+N.openClass)).off(jse.libs.template.events.TRANSITION_FINISHED()).one(jse.libs.template.events.TRANSITION_FINISHED(),function(){H(o,""),o.removeClass("leave")}).trigger(jse.libs.template.events.TRANSITION(),w)},"number"==typeof a?a:N.leaveDelay)}}},Y=function(e){var t=$(this),n=f.id<=N.breakpoint?"mobile":"desktop",a=N.events&&N.events[n]?N.events[n]:[];H(t,"mouse"),$.inArray(e.data.event,a)>-1&&W.call(t,e,n,e.data.delay),(t.hasClass("custom")||y&&0===t.children("ul").length)&&"click"===e.data.event&&!t.find("form").length&&(e.preventDefault(),e.stopPropagation(),"_blank"===t.find("a").attr("target")?window.open(t.find("a").attr("href")):location.href=t.find("a").attr("href"))},x=function(e){e.stopPropagation();var t=$(this),a=f.id<=N.breakpoint?"mobile":"desktop",o=N.events&&N.events[a]?N.events[a]:[];i.find(".enter-category").show(),i.find(".dropdown > a").on("click",function(e){e.preventDefault()}),"start"===e.data.type?(C={event:e,timestamp:(new Date).getTime(),top:n.scrollTop()},i.off("mouseenter.menu mouseleave.menu")):$.inArray("touch",o)>-1&&!O(e)&&(H(t,"touch"),$.inArray("hover",o)!==-1&&"pointerdown"===d.start||W.call(t,e,a),i.on("mouseleave",function(){i.on("mouseenter.menu","li",{event:"hover"},Y).on("mouseleave.menu","li",{event:"hover",action:"leave"},Y)}))},B=function(e){T={event:e,timestamp:(new Date).getTime(),top:n.scrollTop()}},K=function(e,n){n!==t&&0===t.find($(e.target)).length&&(R(),"horizontal"===N.menuType&&i.find(".touch, .mouse, .leave, ."+N.openClass).removeClass("touch mouse leave "+N.openClass))},q=function(e){e.preventDefault(),e.stopPropagation(),$(this).parents(".navbar-topbar-item").length>0||($(this).hasClass("dropdown")?$(this).hasClass(N.openClass)?$(this).removeClass(N.openClass).find("."+N.openClass).removeClass(N.openClass):$(this).addClass(N.openClass).parentsUntil(t,"li").addClass(N.openClass):location.href=$(this).find("a").attr("href"))},G=function(){i.on(d.start+".menu","li",{type:"start"},x).on(d.move+".menu","li",{type:"start"},B).on(d.end+".menu","li",{type:"end"},x).on("click.menu","li",{event:"click",delay:0},Y).on("mouseenter.menu","li",{event:"hover",action:"enter"},Y).on("mouseleave.menu","li",{event:"hover",action:"leave"},Y),a.on(jse.libs.template.events.MENU_REPOSITIONED(),U)},J=function(){i.off(d.start+".menu","li").off(d.move+".menu","li").off(d.end+".menu","li").off("click.menu","li").off("mouseenter.menu","li").off("mouseleave.menu","li")};return k.init=function(e){if(d=jse.core.config.get("touch"),w.classOpen=N.openClass,D(),_(),a.on(jse.libs.template.events.BREAKPOINT(),L).on(jse.libs.template.events.OPEN_FLYOUT()+" click "+d.end,K),"horizontal"===N.menuType&&G(),"vertical"===N.menuType&&(N.accordion===!0&&t.on("click","li",q),0===$("#categories").length)){var n='<div id="categories"><div class="navbar-collapse collapse"><nav class="navbar-default navbar-categories hidden"></nav></div></div>';$("#header").append(n)}if(L(),t.find("."+N.ignoreClass).on("mouseleave.menu mouseenter.menu click.menu "+d.start+" "+d.end,"li",function(e){e.stopPropagation()}),N.openActive){var i=t.find(".active");i.parentsUntil(t,"li").addClass("open")}e()},k});