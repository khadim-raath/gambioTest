"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};gambio.widgets.module("product_cart_handler",["form","xhr",gambio.source+"/libs/events",gambio.source+"/libs/modal.ext-magnific",gambio.source+"/libs/modal"],function(e){var t=$(this),a=$(window),n=$("body"),r=null,i=null,o=null,s=null,l=null,d=null,c=null,u=null,f=!1,p=null,g={},h={ajax:!0,confirmDelete:!1,deleteInput:"#field_cart_delete_products_id",updateTarget:".shipping-calculation",checkUrl:"shop.php?do=CheckQuantity",updateUrl:"shop.php?do=Cart",changeClass:"has-changed",errorClass:"error",cartEmpty:".cart-empty",cartNotEmpty:".cart-not-empty",classLoading:"loading",actions:{add:"wishlist_to_cart","delete":"update_product",refresh:"update_wishlist"},ajaxActions:{add:"shop.php?do=WishList/AddToCart","delete":"shop.php?do=Cart/Delete",refresh:"shop.php?do=Cart/Update"},selectorMapping:{buttons:".shopping-cart-button",giftContent:".gift-cart-content-wrapper",giftLayer:".gift-cart-layer",shareContent:".share-cart-content-wrapper",shareLayer:".share-cart-layer",hiddenOptions:"#cart_quantity .hidden-options",message:".global-error-messages",infoMessage:".info-message",shippingInformation:"#shipping-information-layer",totals:"#cart_quantity .total-box",errorMsg:".error-msg"}},m=$.extend(!1,{},h,e),v={},b=function(e){m.ajax?c=m.ajaxActions[e]:m.actions&&m.actions[e]&&(c=c.replace(/(action=)[^\&]+/,"$1"+m.actions[e]),r.attr("action",c))},y=function(e){e.find('input[type="text"]').each(function(){var e=$(this),t=e.val();e.data("oldValue",t)})},_=function(e){$.each(e,function(){var e=this;e.target.find("."+m.changeClass).each(function(){var t=$(this),a=t.attr("name").replace("[]",""),n=t.data().oldValue;e[a][0]=n,t.val(n).removeClass(m.changeClass)})})},C=function(e){var t=e&&e.length?e:r,a=e&&e.length?e:r.find(".order-wishlist .item:gt(0)"),n=r.find('.hidden-options input[type="hidden"]'),i=jse.libs.form.getData(t),o=[],s=null;return $.each(i.products_id,function(e,t){s={},s.target=a.eq(e),$.each(i,function(t,a){"object"===("undefined"==typeof a?"undefined":_typeof(a))&&void 0!==a[e]&&(s[t]=[a[e]])}),n.filter('[name^="id['+t+'"], .force').each(function(){var e=$(this),t=e.attr("name");s[t]=e.val()}),o.push(s)}),o},j=function(e,t,a){var n=[],r=!1;a=a||C(),$.each(a,function(){var e=this.target.find("."+m.changeClass);return r=r||!!e.length,!r});var i=function(){t&&_(a),$.each(a,function(){var e=this,t=e.target,a=$.Deferred(),r=e.products_id[0].split("x");n.push(a),e.products_id[0]=r[0],e.combination=r[1],delete e.target,$.each(e,function(t,a){"object"===("undefined"==typeof a?"undefined":_typeof(a))&&void 0!==a[0]&&(e[t]=a[0])}),jse.libs.xhr.ajax({url:m.checkUrl,data:e},!0).done(function(n){var r=n.success;void 0!==e.combination&&0===n.status_code?(jse.libs.template.helpers.fill(n.combination,t,m.selectorMapping),r=!1):jse.libs.template.helpers.fill(n.quantity,t,m.selectorMapping),r?(t.removeClass(m.errorClass),a.resolve()):(t.addClass(m.errorClass),a.reject())})})};if(r)if(e){var o=$.Deferred();n.push(o),jse.libs.template.modal.confirm({content:jse.core.lang.translate("CART_WISHLIST_REFUSE","general"),title:jse.core.lang.translate("CART_WISHLIST_REFUSE_TITLE","general")}).done(i).fail(function(){o.reject()}).always(function(){o.isRejected||o.resolve()})}else i();else i();return $.when.apply(void 0,n).promise()},T=function(e,t){return delete g["product_"+e],t.removeClass("loading"),g},E=function(e,a,r){jse.libs.template.helpers.fill(a.content,n,m.selectorMapping),$(".info-message").toggleClass("hidden",""===$(".info-message").text()),i.trigger(jse.libs.template.events.CART_UPDATED(),[]),n.trigger(jse.libs.template.events.CART_UPDATE(),"add"===r),y(e),$.isEmptyObject(a.products)?(l.addClass("hidden"),s.removeClass("hidden")):(s.addClass("hidden"),l.removeClass("hidden")),window.gambio.widgets.init(t)},x=function(e,t,a,n,i){if(m.ajax)delete a.target,e.trigger(jse.libs.template.events.TRANSITION(),p),jse.libs.xhr.ajax({url:c,data:a},!0).done(function(e){var a=$(e.products["product_"+n]||"");a.removeClass(m.classLoading),t.replaceWith(a),E(t,e,i)}).always(function(){T(n,e)});else{var o=$.Deferred();o.always(function(){T(n,e)}),r.trigger("submit",o)}},S=function(){var e=$(this),t=e.val(),a=e.data().oldValue;t!==a?e.addClass(m.changeClass):e.removeClass(m.changeClass)},I=function(e){e.preventDefault(),e.stopPropagation();var t=$(this),a=t.closest(".item"),r=e.data.type,i=C(a)[0],s=i.products_id[0],l=i.target;l.find(".product-title").text();if(a.addClass("loading"),$.isEmptyObject(g)||m.ajax&&!g["product_"+s])switch(g["product_"+s]=!0,b(r),r){case"delete":if(o.val(s),i[d]=[s],m.confirmDelete){var c=jse.core.lang.translate("CART_WISHLIST_DELETE_TITLE","general"),u=jse.core.lang.translate("CART_WISHLIST_DELETE","general");jse.libs.template.modal.confirm({content:u,title:c}).done(function(){var e=$.Deferred();e.done(function(){x(a,l,i,s,r)}),n.trigger(jse.libs.template.events.WISHLIST_CART_DELETE(),[{deferred:e,dataset:i}])}).fail(function(){T(s,a)})}else{var f=$.Deferred();f.done(function(){x(a,l,i,s,r)}),n.trigger(jse.libs.template.events.WISHLIST_CART_DELETE(),[{deferred:f,dataset:i}])}break;default:j(!1,!1,[$.extend(!0,{},i)]).done(function(){o.val("");var e=null;if("add"===r&&(e=jse.libs.template.events.WISHLIST_TO_CART()),e){var t=$.Deferred();t.done(function(){x(a,l,i,s,r)}),n.trigger(e,[{deferred:t,dataset:i}])}else x(a,l,i,s,r)}).fail(function(){T(s,a)})}},w=function(e,t){if(e.preventDefault(),e.stopPropagation(),!t&&e.originalEvent){var a=$(e.originalEvent.explicitOriginalTarget);a.length&&a.is('input[type="text"]')&&a.closest(".item").find(".button-refresh").first().trigger("click")}else t&&j().done(function(){r.off("submit").trigger("submit"),"object"===("undefined"==typeof t?"undefined":_typeof(t))&&t.resolve()}).fail(function(){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&t.reject()})},D=function(e){e.preventDefault(),e.stopPropagation();var t=$(this),a=t.attr("href");!$.isEmptyObject(g)||u||f||(u=!0,j(!0,!0).done(function(){location.href=a}).always(function(){u=!1}))},L=function(e,t){e.stopPropagation(),t=t||{},j(t.showChanges,t.revertChanges).done(function(){t.deferred&&t.deferred.resolve()}).fail(function(){t.deferred&&t.deferred.reject()})},A=function(){f=!0,jse.libs.xhr.ajax({url:m.updateUrl},!0).done(function(e){var t=r.find(".order-wishlist .item").first(),a=$();$.each(e.products,function(e,n){var i=e.replace("product_",""),o=r.find('input[name="products_id[]"][value="'+i+'"]'),s=null;if(o.length){s=o.closest(".item");var l=s.find('input[name="cart_quantity[]"]'),d=parseFloat(l.data().oldValue),c=parseFloat(l.val()),u=parseFloat($(n).find('input[name="cart_quantity[]"]').val());l.data("oldValue",u),d===c&&c!==u?l.addClass(m.changeClass):d!==c&&c===u&&l.removeClass(m.changeClass)}else s=$(n),s.insertAfter(t);a.add(s),t=s}),E(a,e)}).always(function(){f=!1})};return v.init=function(e){i=$(m.updateTarget),s=$(m.cartEmpty),l=$(m.cartNotEmpty),o=$(m.deleteInput),r=t.find("form").first(),d=o.attr("name"),c=r.attr("action"),p={open:!0,classOpen:m.classLoading},y(r),r.on("change",'input[type="text"]',S).on("click.delete",".button-delete",{type:"delete"},I).on("click.refresh",".button-refresh",{type:"refresh"},I).on("click.addtocart",".button-to-cart",{type:"add"},I).on("click.submit",".button-submit",{type:"submit"},D).on("submit",w).on(jse.libs.template.events.CHECK_CART(),L),m.updateUrl&&a.on("focus",A),e()},v});