/* MegadropdownHandler.js <?php
#   --------------------------------------------------------------
#   MegadropdownHandler.js 2014-08-08 gambio
#   Gambio GmbH
#   http://www.gambio.de
#   Copyright (c) 2014 Gambio GmbH
#   Released under the GNU General Public License (Version 2)
#   [http://www.gnu.org/licenses/gpl-2.0.html]
#   --------------------------------------------------------------
?>*/
/*<?php
if($GLOBALS['coo_debugger']->is_enabled('uncompressed_js') == false)
{
?>*/
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('4 11(){2(9)i.h(\'11 2b\');6 f=j,1j=j,8=3;3.19=4(){2(9)i.h(\'11 19\');$(\'.N a\').P(\'v\');$(\'.N a\').v(4(a){2(9)i.h(\'.N a v\');6 b=$(3).y(\'1s\');2(b!=8.O()){8.D(b);6 c=a.24,X=a.1P;2(9)i.h(\'.N 2a \'+c);2(9)i.h(\'.N X \'+X);V.U(4(){8.K(j,c,X)},1)}k j});$(\'.F a\').P(\'v\');$(\'.F a\').v(4(){2(9)i.h(\'.F v\');6 a=$(3).y(\'1s\');8.D(a);V.U(4(){8.13(j)},29);k n});2(S 1R==\'T\'){$(\'.F a\').P(\'H\');$(\'.F a\').H(4(){2(9)i.h(\'.F H\');8.D(j);V.U(4(){8.I()},1z);k n});$(\'.l\').P(\'H\');$(\'.l\').H(4(){2(9)i.h(\'.l H\');8.D(j);V.U(4(){8.I()},1z);k n})}$(\'.l\').P(\'v\');$(\'.l\').v(4(){2(9)i.h(\'.l v\');8.D(n);k n})};3.19();3.K=4(a,b,c){2(9)i.h(\'K 1N \'+a);2(9)i.h(\'K 1O \'+b);2(9)i.h(\'K 1Q \'+c);6 d=a;2(d==j){d=8.O()}2(d==j){k j}6 e=$(\'#r\'+d).1p;2(9)i.h(\'1y \'+e);2(e>0){$(\'#r\'+d).1D();8.1h(d);8.1w(d,b,c);8.1g(d);8.18(d,n);2(1B(\'1C\')){8.Y(d)}}k n};3.13=4(a){2(9)i.h(\'13 \'+a);6 b=a;2(b==j){b=8.O()}2(b==j){k j}8.I(n);6 c=$(\'#r\'+b).1p;2(9)i.h(\'1y \'+c);2(c>0){$(\'#26\'+b).28(\'q\');$(\'#r\'+b).1D();8.1h(b);8.1r(b);8.1v();8.1g(b);8.18(b,j);2(1B(\'1C\')){8.Y(b)}}k n};3.18=4(a,b){6 c=\'#r\'+a,15=\'\',12=\'\',1b=\'\';2(b==n){15=$(c+\' .l-C\').p(\'G-o-1l\');12=$(c+\' .l-C\').p(\'G-o-1m\');1b=$(c+\' .l-C\').p(\'G-o-s\')}$(c+\' .l-C\').p(\'G-z-1l\',15);$(c+\' .l-C\').p(\'G-z-1m\',12);$(c+\' .l-C\').p(\'G-z-s\',1b);k n};3.Y=4(a){2(9)i.h(\'Y()\');6 b=\'#r\'+a;$(b+\' .l-C\').p(\'1q-1S\',\'1T\')};3.I=4(a){2(a!=n){2(8.O()!=j){2(9)i.h(\'I() 1Z\');k j}}$(\'.l\').20();$(\'.q\').22(\'q\');2(9)i.h(\'I() 23\');k j};3.1h=4(a){6 b=\'#r\'+a,u=$(\'#t .q\').w().o,1t=$(\'#t .q\').s(),1u=$(\'#E\').s(),B=$(\'#E\').w().o;2((u+1t)-B<1x&&(B+1u-u)<1x){$(b).s(2i)}};3.1g=4(d){6 e=\'#r\'+d,Q=1k($(e).s()/$(".14").s()),M=1V 1W();$(e+\' .14\').1G(4(a){6 b=$(3).y(\'16\');2(S b==\'T\')b=$(3).y(\'21\');2(S b==\'T\')b=$(3).16();6 c=1k(a/Q);2(0==a%Q){M[c]=b}17{2(b>M[c]){M[c]=b}}});$(e+\' .14\').1G(4(a){6 b=1k(a/Q);$(3).16(M[b])})};3.1w=4(a,b,c){6 d=\'#r\'+a,1n=$(\'#E\').w().z,B=$(\'#E\').w().o,1o=b-1n-5,J=c-B-5;$(d).p(\'z\',1o);$(d).p(\'o\',J)};3.1r=4(a){6 b=\'#r\'+a,u=$(\'#t .q\').w().o;2((A.1a)&&(10.1c.1d("1e 7.")!=-1)){6 c=$(\'#t .q\').y(\'1f\');u=3.R(c);2(9)i.h(\'Z,  1U \'+u)}6 d=$(b).s(),B=$(\'#E\').w().o,1A=$(\'#E\').s();2((u-B)+d<1A){3.Z(a)}17{3.1i(a)}};3.1v=4(){6 a=$(\'#t\').1X().z+$(\'#t\').1Y(n);$(\'.l\').p(\'z\',a)};3.R=4(a){6 L=0,m=A.1E(a);1F(m.W){L+=(m.1H)?m.1H:0;2(m==A.1I)1J;m=m.W}k L};3.27=4(a){6 L=0,m=A.1E(a);1F(m.W){L+=(m.1K)?m.1K:0;2(m==A.1I)1J;m=m.W}k L};3.Z=4(a){2(9)i.h(\'Z\');6 b=\'#r\'+a,J=$(\'#t .q\').w().o;2((A.1a)&&(10.1c.1d("1e 7.")!=-1)){6 c=$(\'#t .q\').y(\'1f\');J=3.R(c)}$(b).p(\'o\',J-1)};3.1i=4(a){2(9)i.h(\'1i\');6 b=\'#r\'+a,u=$(\'#t .q\').w().o;2((A.1a)&&(10.1c.1d("1e 7.")!=-1)){6 c=$(\'#t .q\').y(\'1f\');u=3.R(c)}6 d=$(\'#t .q\').s(),1L=u+d,1M=$(b).s(),x=$(b+\' .l-2c\').p(\'1q-2d\');2(S x==\'T\'){x=0}17{x=x.2e(/2f/g,\'\');x=2g(x)}6 e=1L-1M+x-1;$(b).p(\'o\',e-1)};3.D=4(a){1j=a};3.O=4(){k 1j};3.2h=4(a){f=a};3.25=4(){k f}}',62,143,'||if|this|function||var||coo_this|fb||||||||log|console|false|return|megadropdown|tempEl|true|left|css|dropdown|megadropdown_box_id_|width|head_navi|t_button_left|mouseover|offset|t_shadow_padding|attr|top|document|t_container_left|inside|set_open_categories_id|container|megadropdown_top_link|border|mouseout|close_dropdown|t_dropdown_left|open_flyout||elementHeightArray|flyout_link|get_open_categories_id|unbind|countElementsInLine|get_real_left_ie|typeof|undefined|setTimeout|window|parentNode|t_left|do_ie_corrections|align_dropdown_left|navigator|MegadropdownHandler|t_border_style_value|open_dropdown|top_li|t_border_color_value|height|else|set_top_border|init_binds|all|t_border_width_value|appVersion|indexOf|MSIE|id|fit_categories|fit_dropdown|align_dropdown_right|v_open_categories_id|parseInt|color|style|t_container_top|t_dropdown_top|length|padding|align_dropdown|rel|t_button_width|t_container_width|align_dropdown_top|align_flyout|600|t_found_divs|500|t_body_width|checkBrowserName|msie|show|getElementById|while|each|offsetLeft|body|break|offsetTop|t_button_right|t_dropdown_width|p_categories_id|p_top|pageX|p_left|gm_style_edit_mode_running|bottom|20px|t_dropdown_left1b|new|Array|position|outerHeight|canceled|hide|offsetHeight|removeClass|done|pageY|get_dropdown_active|megadropdown_top_link_id_|get_real_top_ie|addClass|250|t_top|ready|shadow|right|replace|px|Number|set_dropdown_active|410'.split('|'),0,{}));
/*<?php
}
else
{
?>*/
function MegadropdownHandler()
{
    if(fb)console.log('MegadropdownHandler ready');

	var v_dropdown_active = false;
	var v_open_categories_id = false;
	var coo_this = this;

	this.init_binds = function()
	{
		if(fb)console.log('MegadropdownHandler init_binds');

		// open on link click
		$('.flyout_link a').unbind('mouseover');
		$('.flyout_link a').mouseover(function(event)
		{
			if(fb)console.log('.flyout_link a mouseover');

			var t_categories_id = $(this).attr('rel');
			if(t_categories_id != coo_this.get_open_categories_id())
			{
				// open dropdown
				coo_this.set_open_categories_id(t_categories_id);

				// get mouse position
				var t_top = event.pageY;
				var t_left = event.pageX;

				if(fb)console.log('.flyout_link t_top '+ t_top);
				if(fb)console.log('.flyout_link t_left '+ t_left);

				// initialize opening...
				window.setTimeout(function(){coo_this.open_flyout(false, t_top, t_left);}, 1);
			}
			return false;
		});


		// open on header mouseover
		$('.megadropdown_top_link a').unbind('mouseover');
		$('.megadropdown_top_link a').mouseover(function()
		{
			if(fb)console.log('.megadropdown_top_link mouseover');

			// open dropdown
			var t_categories_id = $(this).attr('rel');
			coo_this.set_open_categories_id(t_categories_id);

			// initialize opening...
			window.setTimeout(function(){coo_this.open_dropdown(false);}, 250);
			return true;
		});

		// dont bind closing events, if styleedit is running
		if(typeof gm_style_edit_mode_running == 'undefined')
		{
			// close after header mouseout
			$('.megadropdown_top_link a').unbind('mouseout');
			$('.megadropdown_top_link a').mouseout(function()
			{
				if(fb)console.log('.megadropdown_top_link mouseout');
				coo_this.set_open_categories_id(false);

				// initialize closing...
				window.setTimeout(function(){coo_this.close_dropdown()}, 500);
				return true;
			});

			// close after dropdown mouseout
			$('.megadropdown').unbind('mouseout');
			$('.megadropdown').mouseout(function()
			{
				if(fb)console.log('.megadropdown mouseout');
				coo_this.set_open_categories_id(false);

				// initialize closing...
				window.setTimeout(function(){coo_this.close_dropdown()}, 500);
				return true;
			});
		}

		// prevent closing
		$('.megadropdown').unbind('mouseover');
		$('.megadropdown').mouseover(function()
		{
			if(fb)console.log('.megadropdown mouseover');
			// cancel closing
			coo_this.set_open_categories_id(true);

			return true;
		});
	}

	this.init_binds();


	this.open_flyout = function(p_categories_id, p_top, p_left)
	{
		if(fb)console.log('open_flyout p_categories_id ' + p_categories_id);
		if(fb)console.log('open_flyout p_top ' + p_top);
		if(fb)console.log('open_flyout p_left ' + p_left);

		// use given categories_id
		var t_categories_id = p_categories_id;

		// use global categories_id, if given empty
		if(t_categories_id == false) {
			t_categories_id = coo_this.get_open_categories_id();
		}

		// cancel, if categories_id still empty
		if(t_categories_id == false) {
			return false;
		}

		//hide old dropdown and remove highlighting (true=force)
		//coo_this.close_dropdown(true);

		var t_found_divs = $('#megadropdown_box_id_' + t_categories_id).length;
		if(fb)console.log('t_found_divs ' + t_found_divs);

		if(t_found_divs > 0)
		{
			//show dropdown
			$('#megadropdown_box_id_' + t_categories_id).show();

			// fit dropdown width
			coo_this.fit_dropdown(t_categories_id);

			// set flyout position
			coo_this.align_flyout(t_categories_id, p_top, p_left);

			//fit floating categories inside
			coo_this.fit_categories(t_categories_id);

			// flyouts need border on top
			coo_this.set_top_border(t_categories_id, true);

			// do some corrections for msie
			if(checkBrowserName('msie'))
			{
				coo_this.do_ie_corrections(t_categories_id);
			}
		}
		
		return true;
	}


	this.open_dropdown = function(p_categories_id)
	{
		if(fb)console.log('open_dropdown ' + p_categories_id);

		// use given categories_id
		var t_categories_id = p_categories_id;

		// use global categories_id, if given empty
		if(t_categories_id == false) {
			t_categories_id = coo_this.get_open_categories_id();
		}

		// cancel, if categories_id still empty
		if(t_categories_id == false) {
			return false;
		}

		//hide old dropdown and remove highlighting (true=force)
		coo_this.close_dropdown(true);

		var t_found_divs = $('#megadropdown_box_id_' + t_categories_id).length;
		if(fb)console.log('t_found_divs ' + t_found_divs);

		if(t_found_divs > 0)
		{
			// highlight clicked category
			$('#megadropdown_top_link_id_'+ t_categories_id).addClass('dropdown');

			//show dropdown
			$('#megadropdown_box_id_' + t_categories_id).show();

			// fit dropdown width
			coo_this.fit_dropdown(t_categories_id);

			// set dropdown position
			coo_this.align_dropdown(t_categories_id);
			coo_this.align_dropdown_top();

			//fit floating categories inside
			coo_this.fit_categories(t_categories_id);

			// dropdowns mustn't have border on top
			coo_this.set_top_border(t_categories_id, false);

			// do some corrections for msie
			if(checkBrowserName('msie'))
			{
				coo_this.do_ie_corrections(t_categories_id);
			}
		}
		
		return true;
	}


	this.set_top_border = function(p_categories_id, p_show_border)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		var t_border_color_value = '';
		var t_border_style_value = '';
		var t_border_width_value = '';

		if(p_show_border == true)
		{
			t_border_color_value = $(t_active_dropdown + ' .megadropdown-inside').css('border-left-color');
			t_border_style_value = $(t_active_dropdown + ' .megadropdown-inside').css('border-left-style');
			t_border_width_value = $(t_active_dropdown + ' .megadropdown-inside').css('border-left-width');
		}

		$(t_active_dropdown + ' .megadropdown-inside').css('border-top-color', t_border_color_value);
		$(t_active_dropdown + ' .megadropdown-inside').css('border-top-style', t_border_style_value);
		$(t_active_dropdown + ' .megadropdown-inside').css('border-top-width', t_border_width_value);

		return true;
	}

	this.do_ie_corrections = function(p_categories_id)
	{
		if(fb)console.log('do_ie_corrections()');

		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;

		// padding correction
		$(t_active_dropdown + ' .megadropdown-inside').css('padding-bottom', '20px');

		// left-position correction
//		var t_dropdown_left = $(t_active_dropdown).attr('offsetLeft');
//		t_dropdown_left = t_dropdown_left + 10;
//		t_dropdown_left = t_dropdown_left;
//		$(t_active_dropdown).css('left', t_dropdown_left);
	}


	this.close_dropdown = function(p_force_closing)
	{
		// check only, if not forcing
		if(p_force_closing != true)
		{
			// close only, if categories_id is false
			if(coo_this.get_open_categories_id() != false) {
				if(fb)console.log('close_dropdown() canceled');
				return false;
			}
		}

		$('.megadropdown').hide(); //removing dropdown box
		$('.dropdown').removeClass('dropdown'); //removing button highlighting

		if(fb)console.log('close_dropdown() done');
		return false;
	}


	this.fit_dropdown = function(p_categories_id)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		
		var t_button_left = $('#head_navi .dropdown').offset().left;
		var t_button_width = $('#head_navi .dropdown').width();
		
		var t_container_width = $('#container').width();
		var t_container_left = $('#container').offset().left;


		if((t_button_left+t_button_width)-t_container_left < 600 && (t_container_left+t_container_width-t_button_left) < 600)
		{
			$(t_active_dropdown).width(410);
		}
	}


	this.fit_categories = function(p_categories_id)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		// get Elements in one Line
		var countElementsInLine = parseInt($(t_active_dropdown).width()/$(".top_li").width()); // 1 || 2 || 3
		
		// Array for new item height
		var elementHeightArray = new Array();

		$(t_active_dropdown + ' .top_li').each(function(index)
		{
			// get this height
			var t_height = $(this).attr('height');	//firefox
			if(typeof t_height == 'undefined') t_height = $(this).attr('offsetHeight'); //IE
			if(typeof t_height == 'undefined') t_height = $(this).height(); //Opera
			
			// get position of this element
			var pos = parseInt(index/countElementsInLine);
			
			// check if first position in this line
			if(0 == index%countElementsInLine){
				// add value of first element
				elementHeightArray[pos] = t_height;
			}else{	
				// check if this height > previous height
				if(t_height > elementHeightArray[pos]){
					elementHeightArray[pos] = t_height;
				}
			}
		});
		
		$(t_active_dropdown + ' .top_li').each(function(index)
		{
			// set this height from Array (item height)
			var pos = parseInt(index/countElementsInLine);
			$(this).height(elementHeightArray[pos]);
		});
	}


	this.align_flyout = function(p_categories_id, p_top, p_left)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;

		var t_container_top =  $('#container').offset().top;
		var t_container_left =  $('#container').offset().left;

		var t_dropdown_top = p_top - t_container_top - 5;
		var t_dropdown_left = p_left - t_container_left - 5;

		$(t_active_dropdown).css('top', t_dropdown_top);
		$(t_active_dropdown).css('left', t_dropdown_left);
	}


	this.align_dropdown = function(p_categories_id)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		var t_button_left = $('#head_navi .dropdown').offset().left;

		if((document.all) && (navigator.appVersion.indexOf("MSIE 7.") != -1))
		{
			var t_id = $('#head_navi .dropdown').attr('id');
			t_button_left = this.get_real_left_ie(t_id);
			if(fb)console.log('align_dropdown_left,  t_dropdown_left1b '  + t_button_left);
		}


		var t_dropdown_width = $(t_active_dropdown).width();
//		var t_body_width = $('#container_inner').attr('offsetWidth');

        var t_container_left = $('#container').offset().left;
        
		var t_body_width = $('#container').width();
		/*
		if(fb)console.log('t_button_left: '  + t_button_left);
		if(fb)console.log('t_dropdown_width: '  + t_dropdown_width);
		if(fb)console.log('t_body_width: '  + t_body_width);
		*/
          
		if((t_button_left-t_container_left) + t_dropdown_width < t_body_width) {
			this.align_dropdown_left(p_categories_id);
		} else {
			this.align_dropdown_right(p_categories_id);
		}
	}

	//TODO: justify border
	this.align_dropdown_top = function()
	{
		var t_dropdown_top = $('#head_navi').position().top + $('#head_navi').outerHeight(true);
		$('.megadropdown').css('top', t_dropdown_top);
	}

	this.get_real_left_ie = function(el)
	{
		var L=0;
		var tempEl = document.getElementById(el);
		while(tempEl.parentNode){
			L+= ( tempEl.offsetLeft) ? tempEl.offsetLeft: 0;
			if(tempEl == document.body) break;
			tempEl = tempEl.parentNode;
		}
		return L;
	}

	this.get_real_top_ie = function(el)
	{
		var L=0;
		var tempEl = document.getElementById(el);
		while(tempEl.parentNode){
			L+= ( tempEl.offsetTop) ? tempEl.offsetTop: 0;
			if(tempEl == document.body) break;
			tempEl = tempEl.parentNode;
		}
		return L;
	}


	this.align_dropdown_left = function(p_categories_id)
	{
		if(fb)console.log('align_dropdown_left');

		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		var t_dropdown_left = $('#head_navi .dropdown').offset().left;

		if((document.all) && (navigator.appVersion.indexOf("MSIE 7.") != -1))
		{
			var t_id = $('#head_navi .dropdown').attr('id');
			t_dropdown_left = this.get_real_left_ie(t_id);
			//if(fb)console.log('align_dropdown_left,  t_dropdown_left1b '  + t_dropdown_left);
		}
		$(t_active_dropdown).css('left', t_dropdown_left - 1);
	}

	this.align_dropdown_right = function(p_categories_id)
	{
		if(fb)console.log('align_dropdown_right');

		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		var t_button_left = $('#head_navi .dropdown').offset().left;

		if((document.all) && (navigator.appVersion.indexOf("MSIE 7.") != -1))
		{
			var t_id = $('#head_navi .dropdown').attr('id');
			t_button_left = this.get_real_left_ie(t_id);
		}

		var t_button_width = $('#head_navi .dropdown').width();
		var t_button_right = t_button_left + t_button_width;

		var t_dropdown_width = $(t_active_dropdown).width();
		var t_shadow_padding = $(t_active_dropdown + ' .megadropdown-shadow').css('padding-right');

		if(typeof t_shadow_padding == 'undefined') {
			t_shadow_padding = 0;
		}	else {
			t_shadow_padding = t_shadow_padding.replace(/px/g, '');
			t_shadow_padding = Number(t_shadow_padding);
		}

		var t_dropdown_left = t_button_right - t_dropdown_width + t_shadow_padding - 1;
		/*
		if(fb)console.log('t_button_right: '  + t_button_right);
		if(fb)console.log('t_dropdown_width: '  + t_dropdown_width);
		if(fb)console.log('t_shadow_padding: '  + t_shadow_padding);
		*/
		$(t_active_dropdown).css('left', t_dropdown_left - 1);
	}



	this.set_open_categories_id = function(p_categories_id)
	{
		v_open_categories_id = p_categories_id;
	}
	this.get_open_categories_id = function()
	{
		return v_open_categories_id;
	}

	this.set_dropdown_active = function(p_status)
	{
		v_dropdown_active = p_status;
	}
	this.get_dropdown_active = function()
	{
		return v_dropdown_active;
	}
}
/*<?php
}
?>*/
