"use strict";$(function(){var e=function(e){var a=$(e.target).parents("tr").attr("id")||$("body").find("#gm_order_id").val();$("#sc_modal_content").empty().addClass("sc_loading");var o=(jse.core.lang.translate("create_label","shipcloud"),[]);o.push({text:jse.core.lang.translate("close","buttons"),"class":"btn",click:function(){$(this).dialog("close"),$("#sc_get_quote").show()}}),o.push({text:jse.core.lang.translate("show_existing_labels","shipcloud"),"class":"btn",click:t,id:"sc_show_labels"}),o.push({text:jse.core.lang.translate("get_quotes","shipcloud"),"class":"btn btn-primary",click:l,id:"sc_get_quote"}),$("#shipcloud_modal").dialog({autoOpen:!1,modal:!0,title:jse.core.lang.translate("create_label","shipcloud"),dialogClass:"gx-container",buttons:o,width:1200,position:{my:"center top",at:"center bottom",of:"#main-header"}}),$("#shipcloud_modal").dialog("open"),$("#sc_modal_content").load("admin.php?do=Shipcloud/CreateLabelForm&template_version=2&orders_id="+a,c)},t=function(e){var t=$('#sc_single_form input[name="orders_id"]').val();return $("#sc_modal_content").empty().addClass("sc_loading"),a(t),$("#sc_show_labels").hide(),$("#sc_get_quote").hide(),!1},a=function(e){$("#sc_modal_content").load("admin.php?do=Shipcloud/LoadLabelList&orders_id="+e+"&template_version=2",function(){gx.widgets.init($("#sc_modal_content")),$("#shipcloud_modal").dialog({title:jse.core.lang.translate("labellist_for","shipcloud")+" "+e}),$("#sc_modal_content").removeClass("sc_loading"),$("form#sc_pickup").on("submit",function(e){e.preventDefault()}),$("#download_labels").on("click",o),$("#order_pickups").on("click",n),$("input.pickup_checkbox").on("click",s),setTimeout(s,200),$("input.pickup_checkbox_all").on("click",function(){$(this).prop("checked")===!0?($("input.pickup_checkbox").prop("checked",!0),$("input.pickup_checkbox").parent().addClass("checked")):($("input.pickup_checkbox").prop("checked",!1),$("input.pickup_checkbox").parent().removeClass("checked")),s()}),$("a.sc-del-label").on("click",function(e){e.preventDefault();var t=$(this).data("shipment-id"),a=$(this).closest("tr");$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/DeleteShipment",data:{shipment_id:t},dataType:"json"}).done(function(e){"ERROR"===e.result?($("#status-output").html(e.error_message).show(),$("#status-output").addClass("alert alert-danger")):($("#status-output").html(jse.core.lang.translate("shipment_deleted","shipcloud")).removeClass().addClass("alert alert-info").show(),$("a, input, td.checkbox > *",a).remove(),a.addClass("deleted-shipment"))}).fail(function(e){$buttonPlace.html(jse.core.lang.translate("submit_error","shipcloud"))})})})},o=function(e){e.preventDefault();var t=[],a={};return $("input.pickup_checkbox:checked").each(function(){var e=$("a.label-link",$(this).closest("tr")).attr("href");t.push(e)}),t&&($("#download_result").show(),$("#download_result").html(jse.core.lang.translate("loading","shipcloud")),a.urls=t,a.page_token=$('#sc_modal_content input[name="page_token"]').val(),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=PackedDownload/DownloadByJson",data:JSON.stringify(a),dataType:"json"}).done(function(e){var t=jse.core.config.get("appUrl")+"/admin/admin.php?do=PackedDownload/DownloadPackage&key="+e.downloadKey;"OK"===e.result&&$("#download_result").html('<iframe class="download_iframe" src="'+t+'"></iframe>'),"ERROR"===e.result&&$("#download_result").html(e.error_message)}).fail(function(e){$("#download_result").html(jse.core.lang.translate("submit_error","shipcloud"))})),!0},n=function(e){if(e.preventDefault(),$("input.pickup_checkbox:checked").length>0){var t=$("form#sc_pickup").serialize();$("#pickup_result").html(jse.core.lang.translate("sending_pickup_request","shipcloud")),$("#pickup_result").show(),$("#pickup_result").addClass("alert alert-warning"),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/PickupShipments",data:t,dataType:"json"}).done(function(e){var t="";e.result_messages.forEach(function(e){t=t+e+"<br>"}),$("#pickup_result").html(t)}).fail(function(e){alert(jse.core.lang.translate("submit_error","shipcloud"))})}return!0},s=function(){$("#sc-labellist-dropdown button, div.pickup_time input").prop("disabled",0===$("input.pickup_checkbox:checked").length)},i=function(){$("#sc_modal_content").load("admin.php?do=Shipcloud/UnconfiguredNote")},l=function(){var e=$("#sc_single_form"),t="";$("#sc_single_form .sc_quote").html(""),$("#sc_single_form .sc_quote").attr("title",""),$('input[name="quote_carriers[]"]:checked').each(function(){var a=$(this).val();$("input.create_label",$(this).closest("tr"));$('input[name="carrier"]',e).val(a),$("#sc_quote_"+a).html(jse.core.lang.translate("loading","shipcloud")),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/GetShipmentQuote",data:e.serialize(),dataType:"json"}).done(function(e){"OK"===e.result?(t=e.shipment_quote,$("#sc_quote_"+a).html(t)):"ERROR"===e.result?($("#sc_quote_"+a).html(jse.core.lang.translate("not_possible","shipcloud")),$("#sc_quote_"+a).attr("title",e.error_message)):"UNCONFIGURED"===e.result&&i()}).fail(function(e){t=jse.core.lang.translate("get_quote_error","shipcloud"),$("#sc_quote_"+a).html(t)})}),$('input[name="carrier"]',e).val("")},c=function(){gx.widgets.init($("#shipcloud_modal")),$("#sc_modal_content").removeClass("sc_loading"),1===$("#sc_single_container").data("is_configured")?$("#sc_show_labels").show():$("#sc_show_labels").hide(),$("#sc_single_form").on("submit",function(e){e.preventDefault()}),$("#sc_single_form input.create_label").on("click",d),$('#sc_single_form select[name="carrier"]').on("change",function(e){$('#sc_single_form input[type="text"]').trigger("change"),$("#sc_single_form .carrier-specific").not(".carrier-"+$(this).val()).hide("fast"),$("#sc_single_form .carrier-"+$(this).val()).not(":visible").show("fast")}),$("#sc_single_form .price_value").on("change",function(){$("#sc_single_form div.sc_quote").html("")}),$("#sc_package_template").on("change",r),$("#sc_single_form input.template_value").on("change",function(){$("#sc_package_template").val("-1")}),$("#sc_get_quote").button("disable"),$('#sc_single_form input[name="quote_carriers[]"]').on("change",function(){$('#sc_single_form input[name="quote_carriers[]"]:checked').length>0?$("#sc_get_quote").button("enable"):$("#sc_get_quote").button("disable")}),$('#sc_single_form input[name="quote_carriers[]"]:first').trigger("change")},r=function(e){var t=$(this).closest("form"),a=$("option:selected",$(this));"-1"!==a.val()&&($('input[name="package[weight]"]',t).val(a.data("weight")),$('input[name="package[height]"]',t).val(a.data("height")),$('input[name="package[width]"]',t).val(a.data("width")),$('input[name="package[length]"]',t).val(a.data("length")))},d=function(e){$("#sc_show_labels").hide(),$("#sc_get_quote").hide();var t=$(this).attr("name");$('input[name="carrier"]').val(t);var o=$("#sc_single_form").serialize();return $("#sc_modal_content").empty().addClass("sc_loading"),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/CreateLabelFormSubmit",data:o,dataType:"json"}).done(function(e){$("#sc_modal_content").removeClass("sc_loading"),"UNCONFIGURED"===e.result?i():"OK"===e.result?a(e.orders_id):e.error_message&&$("#sc_modal_content").html('<div class="sc_error">'+e.error_message+"</div>"),$(".orders .table-main").DataTable().ajax.reload(),$(".orders .table-main").orders_overview_filter("reload")}).fail(function(e){alert(jse.core.lang.translate("submit_error","shipcloud"))}),!1},u=function(e){var t=[],a="";$("table.table tbody tr").each(function(){var e=$(this).attr("id"),a=$("td:nth-child(1) span.single-checkbox",this);a.hasClass("checked")&&t.push(e)}),$("#sc_modal_content").empty().addClass("sc_loading");var o=[];o.push({text:jse.core.lang.translate("get_quotes","shipcloud"),"class":"btn btn-primary",click:m,id:"sc_get_quote"}),o.push({text:jse.core.lang.translate("close","buttons"),"class":"btn",click:function(){$(this).dialog("close"),$("#sc_get_quote").show()}}),$("#shipcloud_modal").dialog({autoOpen:!1,modal:!0,title:jse.core.lang.translate("create_labels","shipcloud"),dialogClass:"gx-container",buttons:o,width:1200,position:{my:"center top",at:"center bottom",of:"#main-header"}}),$("#shipcloud_modal").dialog("open"),t.forEach(function(e){a+="orders[]="+e+"&"}),$("#sc_modal_content").load("admin.php?do=Shipcloud/CreateMultiLabelForm&template_version=2&"+a,p)},p=function(){gx.widgets.init($("#shipcloud_modal")),$("#shipcloud_modal").dialog({title:jse.core.lang.translate("create_labels","shipcloud")}),$("#sc_modal_content").removeClass("sc_loading"),$("#sc_multi_form").on("submit",function(e){return e.preventDefault(),!1}),$("#sc_create_label").hide(),$("#sc_show_labels").hide(),$("#sc_modal_content input, #sc_modal_content select").on("change",function(){$(".sc_multi_quote").hide()}),$("#sc_package_template").on("change",r),$("input.create_label").on("click",_)},_=function(e){var t=$(this).attr("name");$('#sc_multi_form input[name="carrier"]').val(t);var a=$("#sc_multi_form").serialize();return $("#sc_modal_content").empty().addClass("sc_loading"),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/CreateMultiLabelFormSubmit",data:a,dataType:"json"}).done(function(e){$("#sc_modal_content").removeClass("sc_loading"),"UNCONFIGURED"===e.result?i():"OK"===e.result?h(e.orders_ids,e.shipments):e.error_message&&$("#sc_modal_content").html('<div class="sc_error">'+e.error_message+"</div>"),$(".orders .table-main").DataTable().ajax.reload(),$(".orders .table-main").orders_overview_filter("reload")}).fail(function(e){alert(jse.core.lang.translate("submit_error","shipcloud"))}),!1},h=function(e,t){var a={orders_ids:e,shipments:t};$("#sc_modal_content").load(jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/LoadMultiLabelList&template_version=2",{json:JSON.stringify(a)},function(){gx.widgets.init($("#shipcloud_modal")),$("#shipcloud_modal").dialog({title:jse.core.lang.translate("labellist","shipcloud")}),$("#sc_modal_content").removeClass("sc_loading"),$("#sc_get_quote").hide(),$("form#sc_pickup").on("submit",function(e){e.preventDefault()}),$("#download_labels").on("click",o),$("#order_pickups").on("click",n),$("input.pickup_checkbox").on("click",s),setTimeout(s,200),$("input.pickup_checkbox_all").on("click",function(){$(this).prop("checked")===!0?($("input.pickup_checkbox").prop("checked",!0),$("input.pickup_checkbox").parent().addClass("checked")):($("input.pickup_checkbox").prop("checked",!1),$("input.pickup_checkbox").parent().removeClass("checked")),s()})})},m=function(){var e=$("#sc_multi_form").serialize();return $("div.sc_quote").html(""),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/GetMultiShipmentQuote",data:e,dataType:"json"}).done(function(e){if("OK"===e.result){for(var t in e.shipment_quotes)$("#sc_multi_quote_"+e.shipment_quotes[t].orders_id).html(e.shipment_quotes[t].shipment_quote);$("div.sc_multi_quote").show("fast");for(var a in e.carriers_total)$("#sc_quote_"+a).html(e.carriers_total[a])}}).fail(function(e){alert(jse.core.lang.translate("submit_error","shipcloud"))}),!1};$("body").prepend($('<div id="shipcloud_modal" title="'+jse.core.lang.translate("create_label_window_title","shipcloud")+'" style="display: none;"><div id="sc_modal_content"></div></div>'));var g=$(".orders .table-main");g.on("init.dt",function(){var t=function(){g.find(".btn-group.dropdown").each(function(){var t=$(this).parents("tr").data("id"),a=g.data("init-default-row-action")||"edit";jse.libs.button_dropdown.addAction($(this),{text:jse.core.lang.translate("admin_menu_entry","shipcloud"),href:"orders.php?oID="+t+"&action=edit","class":"sc-single",data:{configurationValue:"sc-single"},isDefault:"sc-single"===a,callback:function(t){t.preventDefault(),e(t)}})})};g.on("draw.dt",t),t();var a=$(".bulk-action"),o=g.data("init-default-bulk-action")||"edit";jse.libs.button_dropdown.addAction(a,{text:jse.core.lang.translate("admin_menu_entry","shipcloud"),"class":"sc-multi",data:{configurationValue:"sc-multi"},isDefault:"sc-multi"===o,callback:function(e){e.preventDefault(),u(e)}})})});