"use strict";gx.widgets.module("button_dropdown",["user_configuration_service"],function(t){var n=$(this),e=jse.libs.user_configuration_service,o='<button class="btn" type="button"><i class="fa fa-caret-down"></i></button>',i={fade:{duration:300,easing:"swing"},dropdown_selector:"[data-use-button_dropdown]",config_value_attribute:"data-configuration_value"},a=$.extend(!0,{},i,t),r={element:a.dropdown_selector,mainButton:"button:nth-child(1)",caretButton:"button:nth-child(2)"},s={};a.config_keys=a.config_keys?a.config_keys.split(" "):[];var c=function(){var t=$.Deferred(),n=[],o={};return a.user_id&&a.config_keys.length?($.each(a.config_keys,function(t,i){var r=$.Deferred();e.get({data:{userId:a.user_id,configurationKey:i},onSuccess:function(t){o[i]=t.configurationValue,r.resolve()},onError:function(){r.resolve()}}),n.push(r)}),$.when.apply(null,n).done(function(){t.resolve(o)}),t):t.resolve(null)},u=function(){var t=$.Deferred(),e=[],o=["custom_caret_btn_class","config_key","config_value"];return $(document).ready(function(){n.find(a.dropdown_selector).each(function(t,n){var i=$(n),a={};a.element=n,$.each(o,function(t,n){n in i.data()&&(a[n]=i.data(n))}),e.push(a),i.hide()}),t.resolve(e)}),t},f=function(t){$(t).stop().addClass("hover").fadeIn(a.fade),l(t)},d=function(t){$(t).stop().removeClass("hover").fadeOut(a.fade)},l=function(t){var n=$(t),e=n.closest(a.dropdown_selector);if(n.css({left:"",top:""}),n.offset().left+n.width()>window.innerWidth){var o=n.width()-e.width();n.css("margin-left","-"+o+"px")}if(n.offset().top+n.height()>window.innerHeight){var i=n.height()+10;n.css("margin-top","-"+i+"px")}},g=function(t){t.preventDefault(),t.stopPropagation(),$(this).trigger("perform:action")},_=function(t){t.preventDefault(),t.stopPropagation();var n=$(this).siblings("ul"),e=n.hasClass("hover");e?d(n):f(n)},v=function(t){t.preventDefault(),t.stopPropagation();var n=$(this),e=n.closest("ul"),o=n.closest(a.dropdown_selector);d(e);var i=o.data("config_key"),r=n.data("value");i&&r&&w(i,r),n.trigger("perform:action")},h=function(t){var n=$("ul.hover");d(n)},p=function(t,n){var e=$.Deferred(),i=$(o);return $.each(t,function(t,e){var o=$(e.element),s=o.find("button:first"),c=i.clone();if(e.custom_caret_btn_class&&c.addClass(e.custom_caret_btn_class),s.addClass("btn").after(c),o.addClass("js-button-dropdown"),n&&e.config_key&&n[e.config_key]||e.config_value){var u=e.config_value||n[e.config_key];o.attr(a.config_value_attribute,u)}o.on("click",r.mainButton,g),o.on("click",r.caretButton,_),o.on("click","ul span, ul a",v),o.fadeIn(a.fade.duration,function(){o.css("display","")})}),$(document).on("click",h),e.resolve(),e},w=function(t,n){if(!t||!n)throw new Error("No configuration data passed");e.set({data:{userId:a.user_id,configurationKey:t,configurationValue:n}})};return s.init=function(t){$.when(u(),c()).then(p).then(t)},s});