"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}();gx.controllers.module("info_box",["loading_spinner",gx.source+"/libs/info_box"],function(e){var t=this,s={},i=function(){function e(t,s,i,n,o){_classCallCheck(this,e),this.CLOSE_DELAY=5e3,this.FADEOUT_DURATION=650,this.HIDDEN_CLASS="hidden",this.ACTIVE_CLASS="active",this.OPEN_MODE="_self",this.STATUS_NEW="new",this.STATUS_READ="read",this.STATUS_HIDDEN="hidden",this.STATUS_DELETED="deleted",this.TYPE_INFO="info",this.TYPE_WARNING="warning",this.TYPE_SUCCESS="success",this.VISIBILITY_ALWAYS_ON="alwayson",this.VISIBILITY_HIDEABLE="hideable",this.VISIBILITY_REMOVABLE="removable",this.$element=s,this.$messageCount=s.find(".notification-count"),this.service=i,this.loadingSpinner=n,this.translator=o,this.messageListSelector=".info-box-popover-content",this.messageListCheckboxSelector=".visibility-checkbox",this.messageItemSelector=".message",this.messageItemHiddenSelector='[data-status="hidden"]',this.messageItemButtonSelector=".message-button",this.messageItemActionSelector=".message-action",this.popoverSelector=".info-box-popover",this.popoverArrowSelector="div.arrow",this.successMessageIdentifierPrefix="adminActionSuccess-",this._initPopover(),t()}return _createClass(e,[{key:"checkInitial",value:function(){var e=this,t=function(t){var s=0,i=!1,n=!0,o=!1,r=void 0;try{for(var a,c=t[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var h=a.value;h.status===e.STATUS_NEW&&(i=!0),h.identifier.search(e.successMessageIdentifierPrefix)===-1&&s++}}catch(l){o=!0,r=l}finally{try{!n&&c["return"]&&c["return"]()}finally{if(o)throw r}}e._setMessageCount(s),i&&(e._showPopover(),setTimeout(function(){return e._hidePopover()},e.CLOSE_DELAY))};return this.service.getMessages().then(function(e){return t(e)}),this}},{key:"_showPopover",value:function(){return this.$element.popover("show"),this}},{key:"_initPopover",value:function(){var t=this,s={animation:!1,placement:"bottom",content:" ",trigger:"manual",template:e._createPopoverTemplateElement()};return this.$element.popover(s).on("click",function(e){return t._onButtonClick(e)}).on("shown.bs.popover",function(e){return t._onPopoverShown(e)}).on("show:popover",function(e){return t._showPopover()}).on("refresh:messages",function(e){return t.checkInitial()}),$(window).on("resize",function(){return t._fixPopoverPosition()}).on("click",function(e){return t._onWindowClick(e)}),this}},{key:"_fixPopoverPosition",value:function(){var e=240,t=250,s=$(this.popoverSelector),i=s.find(this.popoverArrowSelector);if(s.length){var n=s.offset().left+e,o=this.$element.offset().left-t+this.$element.width()/2;i.offset({left:n}),s.offset({left:o})}return this}},{key:"_onButtonClick",value:function(){var e=$(this.popoverSelector);return e.length?this._hidePopover():this._showPopover(),this}},{key:"_onPopoverShown",value:function(){var e=this,t=$(this.messageListSelector),s=$(this.popoverSelector);return s.addClass(this.ACTIVE_CLASS).css({top:s.height()*-1}),this._fixPopoverPosition().service.getMessages().then(function(t){return e._fillPopoverContent(t)._markMessagesAsRead()}),t.off("click change").on("click",this.messageItemButtonSelector,function(t){return e._onMessageButtonClick(t)}).on("click",this.messageItemActionSelector,function(t){return e._onMessageActionClick(t)}).on("change",this.messageListCheckboxSelector,function(t){return e._onVisibilityCheckboxChange(t)}),this}},{key:"_hidePopover",value:function(){var e=this;return $(this.popoverSelector).removeClass(this.ACTIVE_CLASS),setTimeout(function(){return e.$element.popover("hide")},this.FADEOUT_DURATION),this}},{key:"_onMessageButtonClick",value:function(e){var t=$(e.target).attr("href");return e.preventDefault(),e.stopPropagation(),t&&t.trim().length&&window.open(t,this.OPEN_MODE),this}},{key:"_onMessageActionClick",value:function(e){var t="message-action-remove",s=$(e.target),i=s.hasClass(t),n=s.parents(this.messageItemSelector).data("id");return i?this._deleteMessage(n):this._hideMessage(n),this}},{key:"_onWindowClick",value:function(e){var t=$(e.target),s=$(this.popoverSelector),i=this.$element.has(t).length||this.$element.is(t).length,n=s.length,o=!s.has(t).length;return o&&n&&!i&&this._hidePopover(),this}},{key:"_onVisibilityCheckboxChange",value:function(e){var t=$(e.target).is(":checked");return this._toggleHiddenMessages(t)._markMessagesAsRead(),this}},{key:"_toggleHiddenMessages",value:function(e){var t=$(this.messageListSelector).find(this.messageItemHiddenSelector);return e?t.removeClass(this.HIDDEN_CLASS):t.addClass(this.HIDDEN_CLASS),this}},{key:"_setMessageCount",value:function(e){return e?this.$messageCount.removeClass(this.HIDDEN_CLASS).text(e):this.$messageCount.addClass(this.HIDDEN_CLASS),this}},{key:"_fillPopoverContent",value:function(e){var t=$(this.messageListSelector),s=$(this.popoverSelector),i=this.loadingSpinner.show(s);i.css({"z-index":9999});var n=0;if(t.empty(),e.length){var o=!1,r=!1,a=!0,c=!1,h=void 0;try{for(var l,u=e[Symbol.iterator]();!(a=(l=u.next()).done);a=!0){var v=l.value,f=v.identifier.search(this.successMessageIdentifierPrefix)!==-1;t.append(this._createMessageElement(v)),v.status===this.STATUS_HIDDEN&&(r=!0),f?o=!0:n++}}catch(d){c=!0,h=d}finally{try{!a&&u["return"]&&u["return"]()}finally{if(c)throw h}}this._setMessageCount(n),r&&!o&&(t.append(this._createVisibilityCheckboxElement()),this._toggleHiddenMessages(!1)),o&&$(this.messageListSelector).find(this.messageItemSelector).not("[data-identifier*="+this.successMessageIdentifierPrefix+"]").remove()}else{var p={message:this.translator.translate("NO_MESSAGES","admin_info_boxes"),visibility:this.VISIBILITY_ALWAYS_ON,status:this.STATUS_READ,headline:"",type:""};t.append(this._createMessageElement(p))}return t.children().each(function(e,t){return $(t).hide().fadeIn()}),this.loadingSpinner.hide(i),this}},{key:"_refreshPopover",value:function(){var e=this,t=$(this.popoverSelector),s=this.loadingSpinner.show(t);return s.css({"z-index":9999}),this.service.getMessages().then(function(t){return e._fillPopoverContent(t)._markMessagesAsRead()}).then(function(){return e.loadingSpinner.hide(s)}),this}},{key:"_markMessagesAsRead",value:function(){var e=this,t=$(this.messageListSelector).find(this.messageItemSelector),s=function(t,s){var i=$(s),n=i.data(),o=i.hasClass(e.STATUS_HIDDEN);!o&&n.id&&(e.service.setStatus(n.id,e.STATUS_READ),i.data("status",e.STATUS_READ)),n.identifier&&n.identifier.search(e.successMessageIdentifierPrefix)!==-1&&e.service.deleteByIdentifier(n.identifier)};return t.each(s),this}},{key:"_deleteMessage",value:function(e){var t=this;return this.service.deleteById(e).then(function(){return t._refreshPopover()}),this}},{key:"_hideMessage",value:function(e){var t=this;return this.service.setStatus(e,this.STATUS_HIDDEN).then(function(){return t._refreshPopover()}),this}},{key:"_createVisibilityCheckboxElement",value:function(){var e=$("<div/>",{"class":"visibility-checkbox-container"}),t=$("<label/>",{"class":"visibility-checkbox-label",text:this.translator.translate("SHOW_ALL","admin_info_boxes")}),s=$("<input/>",{type:"checkbox","class":"visibility-checkbox"});return e.append(s,t),e}},{key:"_createMessageElement",value:function(e){var t=$("<div/>",{"class":"message "+e.type}),s=$("<p/>",{"class":"message-headline",html:e.headline}),i=$("<p/>",{"class":"message-body",html:e.message}),n=$("<div/>",{"class":"message-action-container"}),o=$("<span/>",{"class":"message-action message-action-hide fa fa-minus"}),r=$("<span/>",{"class":"message-action message-action-remove fa fa-times"}),a=!!e.identifier&&e.identifier.search(this.successMessageIdentifierPrefix)!==-1;if(a||e.visibility!==this.VISIBILITY_REMOVABLE?a||e.visibility!==this.VISIBILITY_HIDEABLE?a&&n.append(r).appendTo(t):n.append(o).appendTo(t):n.append(o,r).appendTo(t),t.attr("data-status",e.status).attr("data-id",e.id).attr("data-visibility",e.visibility).attr("data-identifier",e.identifier).append(s,i),e.buttonLabel){var c=$("<a/>",{"class":"btn message-button",text:e.buttonLabel,href:e.buttonLink});t.append(c)}return t}}],[{key:"_createPopoverTemplateElement",value:function(){var e=$("<div/>",{"class":"popover info-box-popover",role:"tooltip"}),t=$("<div/>",{"class":"arrow"}),s=$("<div/>",{"class":"popover-title"}),i=$("<div/>",{"class":"popover-content info-box-popover-content"});return e.append(t,s,i),e}}]),e}();return s.init=function(e){var s=$(t).find(".info-box"),n=jse.libs.info_box.service,o=jse.libs.loading_spinner,r=jse.core.lang,a=new i(e,s,n,o,r);a.checkInitial()},s});