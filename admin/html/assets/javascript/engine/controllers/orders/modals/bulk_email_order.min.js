"use strict";gx.controllers.module("bulk_email_order",["modal","loading_spinner"],function(e){function n(e){e?m=jse.libs.loading_spinner.show(a.find(l),a.css("z-index")):jse.libs.loading_spinner.hide(m)}function t(e){var n=s.bindings.subject.get();return Object.keys(u).forEach(function(t){return n=n.replace(t,e[u[t]])}),n}function i(){var e=jse.core.lang.translate("BULK_MAIL_SUCCESS","gm_send_order");jse.libs.info_box.service.addSuccessMessage(e),n(!1),a.modal("hide")}function o(){var e=jse.core.lang.translate("error","messages"),t=jse.core.lang.translate("BULK_MAIL_UNSUCCESS","gm_send_order");jse.libs.modal.message({title:e,content:t}),n(!1),a.modal("hide")}function r(){var e="send_order",r=jse.core.config.get("appUrl")+"/admin/gm_send_order.php",s=[],l=a.find(d);return l.length?(n(!0),l.each(function(n,i){var o=$(i).data("order"),a="de"===jse.core.config.get("languageCode")?"DD.MM.YY":"MM.DD.YY";o.purchaseDate=moment(o.purchaseDate.date).format(a);var d=$(i).find(c).val(),l={oID:o.id,type:e},u=r+"?"+$.param(l),m={gm_mail:d,gm_subject:t(o)},f=new Promise(function(e,n){var t=$.ajax({method:"POST",url:u,data:m});t.success(function(){var e=l.oID,n=$("tbody tr#"+e);n.find("td.actions i.tooltip-confirmation-not-sent").remove()}),t.done(function(n){return e(n)}),t.fail(function(){return n()})});s.push(f)}),void Promise.all(s).then(i)["catch"](o)):void a.modal("hide")}var a=$(this),s={bindings:{subject:a.find(".subject")}},d=".email-list-item",c=".email-input",l=".modal-content",u={"{ORDER_ID}":"id","{ORDER_DATE}":"purchaseDate"},m=null;return s.init=function(e){a.on("click",".btn.send",r),e()},s});