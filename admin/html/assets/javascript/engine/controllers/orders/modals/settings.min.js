"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();gx.controllers.module("settings",["user_configuration_service","loading_spinner"],function(e){var t=$(this),i={},n=function(){function e(t,i,n,r,s,o){_classCallCheck(this,e),this.$element=i,this.$submitButton=i.find("button.submit-button"),this.$settings=i.find("ul.settings"),this.$modal=i.parents(".modal"),this.$modalFooter=i.find(".modal-footer"),this.$resetDefaultLink=i.find("a.reset-action"),this.$spinner=null,this.sortableHandleSelector="span.sort-handle",this.rowHeightValueSelector="select#setting-value-row-height",this.errorMessageClassName="error-message",this.loadingClassName="loading",this.userCfgService=n,this.loadingSpinner=r,this.translator=o,this.settingListItemIdPrefix="setting-",this.settingValueIdPrefix="setting-value-",this.CONFIG_KEY_COLUMN_SETTINGS="ordersOverviewSettingsColumns",this.CONFIG_KEY_ROW_HEIGHT_SETTINGS="ordersOverviewSettingsRowHeight",this.DEFAULT_ROW_HEIGHT_SETTING="large",this.DEFAULT_COLUMN_SETTINGS=["number","customer","group","sum","paymentMethod","shippingMethod","countryIsoCode","date","status","totalWeight"],this.userId=s,t()}return _createClass(e,[{key:"initialize",value:function(){var e=this;return this.$submitButton.on("click",function(t){return e._onSubmitButtonClick(t)}),this.$resetDefaultLink.on("click",function(t){return e._onResetSettingsLinkClick(t)}),this.$modal.on("show.bs.modal",function(t){return e._onModalShow(t)}).on("shown.bs.modal",function(t){return e._onModalShown(t)}),this}},{key:"_onModalShow",value:function(){return this.$element.addClass(this.loadingClassName),this}},{key:"_onModalShown",value:function(){return this._refreshSettings()._clearErrorMessage()._initSortable(),this}},{key:"_initSortable",value:function(){var e={items:"> li",axis:"y",cursor:"move",handle:this.sortableHandleSelector,containment:"parent"};return this.$settings.sortable(e).disableSelection(),this}},{key:"_serializeColumnSettings",value:function(){var e=this,t=function(t){return t.replace(e.settingListItemIdPrefix,"")},i=function(t){return e.$settings.find("#"+e.settingValueIdPrefix+t).is(":checked")};return this.$settings.sortable("toArray").map(t).filter(i)}},{key:"_serializeRowHeightSetting",value:function(){return this.$element.find(this.rowHeightValueSelector).val()}},{key:"_onSubmitButtonClick",value:function(){var e=this,t=this._serializeColumnSettings(),i=this._serializeRowHeightSetting();return this._toggleLoadingSpinner(!0)._clearErrorMessage()._saveColumnSettings(t).then(function(){return e._saveRowHeightSetting(i)}).then(function(){return e._onSaveSuccess()})["catch"](function(){return e._onSaveError()}),this}},{key:"_onResetSettingsLinkClick",value:function(e){return e.preventDefault(),e.stopPropagation(),this._setDefaultSettings(),this}},{key:"_toggleLoadingSpinner",value:function(e){return e?(this.$element.addClass(this.loadingClassName),this.$spinner=this.loadingSpinner.show(this.$element),this.$spinner.css({"z-index":9999})):(this.$element.removeClass(this.loadingClassName),this.loadingSpinner.hide(this.$spinner)),this}},{key:"_onSaveSuccess",value:function(){return window.location.reload(),this}},{key:"_clearErrorMessage",value:function(){var e=this.$modalFooter.find("."+this.errorMessageClassName);return e.length&&e.remove(),this}},{key:"_onSaveError",value:function(){var e=this.translator.translate("TXT_SAVE_ERROR","admin_general"),t=$("<span/>",{"class":this.errorMessageClassName,text:e});return this._toggleLoadingSpinner(!1),this.$modalFooter.prepend(t).hide().fadeIn(),this}},{key:"_getColumnSettings",value:function(){var e={userId:this.userId,configurationKey:this.CONFIG_KEY_COLUMN_SETTINGS};return this._getFromUserCfgService(e)}},{key:"_getRowHeightSetting",value:function(){var e={userId:this.userId,configurationKey:this.CONFIG_KEY_ROW_HEIGHT_SETTINGS};return this._getFromUserCfgService(e)}},{key:"_getFromUserCfgService",value:function(e){var t=this,i=function(i,n){var r={onError:function(){return n()},onSuccess:function(e){return i(e.configurationValue)},data:e};t.userCfgService.get(r)};return new Promise(i)}},{key:"_setWithUserCfgService",value:function(e){var t=this,i=function(i,n){var r={onError:function(){return n()},onSuccess:function(e){return i()},data:e};t.userCfgService.set(r)};return new Promise(i)}},{key:"_saveColumnSettings",value:function(e){if(!e||!Array.isArray(e))throw new Error("Missing or invalid column settings");var t={userId:this.userId,configurationKey:this.CONFIG_KEY_COLUMN_SETTINGS,configurationValue:JSON.stringify(e)};return this._setWithUserCfgService(t)}},{key:"_saveRowHeightSetting",value:function(e){if(!e||"string"!=typeof e)throw new Error("Missing or invalid row height setting");var t={userId:this.userId,configurationKey:this.CONFIG_KEY_ROW_HEIGHT_SETTINGS,configurationValue:e};return this._setWithUserCfgService(t)}},{key:"_refreshSettings",value:function(){var e=this;this._toggleLoadingSpinner(!0);var t=function(t){console.warn("Error while refreshing",t),e._toggleLoadingSpinner(!1)};return this._clearErrorMessage()._getRowHeightSetting().then(function(t){return e._setRowHeight(t)}).then(function(){return e._getColumnSettings()}).then(function(t){return e._setColumnSettings(t)}).then(function(){return e._toggleLoadingSpinner(!1)})["catch"](t),this}},{key:"_setRowHeight",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.DEFAULT_ROW_HEIGHT_SETTING;return this.$element.find(this.rowHeightValueSelector).val(e),this}},{key:"_setColumnSettings",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.DEFAULT_COLUMN_SETTINGS,i=/\\/g;Array.isArray(t)||(t=t.replace(i,""),t=JSON.parse(t));var n=$("<div/>"),r=function(t){var i=e.settingListItemIdPrefix+t,r=e.$settings.find("#"+i),s=r.find("#"+e.settingValueIdPrefix+t);s.is(":checked")||s.parent().trigger("click"),r.appendTo(n)};return t.forEach(r),n.children().prependTo(this.$settings),this}},{key:"_setDefaultSettings",value:function(){var e=this,t=this.DEFAULT_COLUMN_SETTINGS,i=this.DEFAULT_ROW_HEIGHT_SETTING,n=$("<div/>"),r=function(t){var i=e.settingListItemIdPrefix+t,r=e.$settings.find("#"+i),s=r.find("#"+e.settingValueIdPrefix+t);s.is(":checked")||s.parent().trigger("click"),r.appendTo(n)};return this.$settings.find(":checkbox").each(function(e,t){var i=$(t);i.is(":checked")&&i.parent().trigger("click")}),t.forEach(r),n.children().prependTo(this.$settings),this.$element.find(this.rowHeightValueSelector).val(i),this}}]),e}();return i.init=function(i){var r=jse.libs.user_configuration_service,s=jse.libs.loading_spinner,o=e.userId,a=jse.core.lang,u=new n(i,t,r,s,o,a);u.initialize()},i});