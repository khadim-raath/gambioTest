"use strict";gx.compatibility.module("orders_shipcloud",[gx.source+"/libs/action_mapper",gx.source+"/libs/button_dropdown","loading_spinner"],function(e){var t=($(this),jse.libs.action_mapper,{}),o=function(){gx.widgets.init($("#shipcloud_modal")),$("#sc_modal_content").removeClass("sc_loading"),1===$("#sc_single_container").data("is_configured")?$("#sc_show_labels").show():$("#sc_show_labels").hide(),$("#sc_single_form").on("submit",function(e){e.preventDefault()}),$("#sc_single_form input.create_label").on("click",_),$('#sc_single_form select[name="carrier"]').on("change",function(e){$('#sc_single_form input[type="text"]').trigger("change"),$("#sc_single_form .carrier-specific").not(".carrier-"+$(this).val()).hide("fast"),$("#sc_single_form .carrier-"+$(this).val()).not(":visible").show("fast")}),$("#sc_single_form .price_value").on("change",function(){$("#sc_single_form div.sc_quote").html("")}),$("#sc_package_template").on("change",a),$("#sc_single_form input.template_value").on("change",function(){$("#sc_package_template").val("-1")}),$("#sc_get_quote").button("disable"),$('#sc_single_form input[name="quote_carriers[]"]').on("change",function(){$('#sc_single_form input[name="quote_carriers[]"]:checked').length>0?$("#sc_get_quote").button("enable"):$("#sc_get_quote").button("disable")}),$('#sc_single_form input[name="quote_carriers[]"]:first').trigger("change")},a=function(e){var t,o;t=$(this).closest("form"),o=$("option:selected",$(this)),"-1"!==o.val()&&($('input[name="package[weight]"]',t).val(o.data("weight")),$('input[name="package[height]"]',t).val(o.data("height")),$('input[name="package[width]"]',t).val(o.data("width")),$('input[name="package[length]"]',t).val(o.data("length")))},n=function(e){var t=$(e.target).parents("tr").data("row-id")||$("body").find("#gm_order_id").val();$("#sc_modal_content").empty().addClass("sc_loading");var a=(jse.core.lang.translate("create_label","shipcloud"),[]);a.push({text:jse.core.lang.translate("close","buttons"),"class":"btn",click:function(){$(this).dialog("close"),$("#sc_get_quote").show()}}),a.push({text:jse.core.lang.translate("show_existing_labels","shipcloud"),"class":"btn",click:u,id:"sc_show_labels"}),a.push({text:jse.core.lang.translate("get_quotes","shipcloud"),"class":"btn btn-primary",click:p,id:"sc_get_quote"}),$("#shipcloud_modal").dialog({autoOpen:!1,modal:!0,title:jse.core.lang.translate("create_label","shipcloud"),dialogClass:"gx-container",buttons:a,width:1e3,position:{my:"center top",at:"center bottom",of:".main-top-header"}}),$("#shipcloud_modal").dialog("open"),$("#sc_modal_content").load("admin.php?do=Shipcloud/CreateLabelForm&orders_id="+t,o)},s=function(){$(".gx-orders-table tr").not(".dataTableHeadingRow").each(function(){jse.libs.button_dropdown.mapAction($(this),"admin_menu_entry","shipcloud",n)}),jse.libs.button_dropdown.mapAction($(".order-footer"),"admin_menu_entry","shipcloud",n)},i=function(){$("#sc-labellist-dropdown button, div.pickup_time input").prop("disabled",0===$("input.pickup_checkbox:checked").length)},l=function(e){$("#sc_modal_content").load("admin.php?do=Shipcloud/LoadLabelList&orders_id="+e,function(){gx.widgets.init($("#sc_modal_content")),$("#shipcloud_modal").dialog({title:jse.core.lang.translate("labellist_for","shipcloud")+" "+e}),$("#sc_modal_content").removeClass("sc_loading"),$("form#sc_pickup").on("submit",function(e){e.preventDefault()}),jse.libs.button_dropdown.mapAction($("#sc-labellist-dropdown"),"download_labels","shipcloud",c),jse.libs.button_dropdown.mapAction($("#sc-labellist-dropdown"),"order_pickups","shipcloud",r),$("input.pickup_checkbox").on("click",i),setTimeout(i,200),$("input.pickup_checkbox_all").on("click",function(){$(this).prop("checked")===!0?($("input.pickup_checkbox").prop("checked",!0),$("input.pickup_checkbox").parent().addClass("checked")):($("input.pickup_checkbox").prop("checked",!1),$("input.pickup_checkbox").parent().removeClass("checked")),i()}),$("a.sc-del-label").on("click",function(e){e.preventDefault();var t=$(this).data("shipment-id"),o=$(this).closest("span.sc-del-label"),a=$(this).closest("tr");$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/DeleteShipment",data:{shipment_id:t},dataType:"json"}).done(function(e){"ERROR"===e.result?(o.html(e.error_message),o.addClass("badge").addClass("badge-danger")):(o.html(jse.core.lang.translate("shipment_deleted","shipcloud")),$("a, input, td.checkbox > *",a).remove(),a.addClass("deleted-shipment"))}).fail(function(e){o.html(jse.core.lang.translate("submit_error","shipcloud"))})})})},c=function(e){e.preventDefault();var t=[],o={};return $("input.pickup_checkbox:checked").each(function(){var e=$("a.label-link",$(this).closest("tr")).attr("href");t.push(e)}),t&&($("#download_result").show(),$("#download_result").html(jse.core.lang.translate("loading","shipcloud")),o.urls=t,o.page_token=$('#sc_modal_content input[name="page_token"]').val(),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=PackedDownload/DownloadByJson",data:JSON.stringify(o),dataType:"json"}).done(function(e){var t=jse.core.config.get("appUrl")+"/admin/admin.php?do=PackedDownload/DownloadPackage&key="+e.downloadKey;"OK"===e.result&&$("#download_result").html('<iframe class="download_iframe" src="'+t+'"></iframe>'),"ERROR"===e.result&&$("#download_result").html(e.error_message)}).fail(function(e){$("#download_result").html(jse.core.lang.translate("submit_error","shipcloud"))})),!0},r=function(e){if(e.preventDefault(),$("input.pickup_checkbox:checked").length>0){var t=$("form#sc_pickup").serialize();$("#pickup_result").html(jse.core.lang.translate("sending_pickup_request","shipcloud")),$("#pickup_result").show(),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/PickupShipments",data:t,dataType:"json"}).done(function(e){var t="";e.result_messages.forEach(function(e){t=t+e+"<br>"}),$("#pickup_result").html(t)}).fail(function(e){alert(jse.core.lang.translate("submit_error","shipcloud"))})}return!0},d=function(){$("#sc_modal_content").load("admin.php?do=Shipcloud/UnconfiguredNote")},u=function(e){var t=$('#sc_single_form input[name="orders_id"]').val();return $("#sc_modal_content").empty().addClass("sc_loading"),l(t),$("#sc_show_labels").hide(),$("#sc_get_quote").hide(),!1},p=function(){var e=$("#sc_single_form"),t="";$("#sc_single_form .sc_quote").html(""),$("#sc_single_form .sc_quote").attr("title",""),$('input[name="quote_carriers[]"]:checked').each(function(){var o=$(this).val();$("input.create_label",$(this).closest("tr"));$('input[name="carrier"]',e).val(o),$("#sc_quote_"+o).html(jse.core.lang.translate("loading","shipcloud")),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/GetShipmentQuote",data:e.serialize(),dataType:"json"}).done(function(e){"OK"===e.result?(t=e.shipment_quote,$("#sc_quote_"+o).html(t)):"ERROR"===e.result?($("#sc_quote_"+o).html(jse.core.lang.translate("not_possible","shipcloud")),$("#sc_quote_"+o).attr("title",e.error_message)):"UNCONFIGURED"===e.result&&d()}).fail(function(e){t=jse.core.lang.translate("get_quote_error","shipcloud"),$("#sc_quote_"+o).html(t)})}),$('input[name="carrier"]',e).val("")},_=function(e){var t,o;return $("#sc_show_labels").hide(),$("#sc_get_quote").hide(),t=$(this).attr("name"),$('input[name="carrier"]').val(t),o=$("#sc_single_form").serialize(),$("#sc_modal_content").empty().addClass("sc_loading"),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/CreateLabelFormSubmit",data:o,dataType:"json"}).done(function(e){$("#sc_modal_content").removeClass("sc_loading"),"UNCONFIGURED"===e.result?d():"OK"===e.result?l(e.orders_id):e.error_message&&$("#sc_modal_content").html('<div class="sc_error">'+e.error_message+"</div>")}).fail(function(e){alert(jse.core.lang.translate("submit_error","shipcloud"))}),!1},m=function(e){var t=[],o="";$('input[name="gm_multi_status[]"]:checked').each(function(){t.push($(this).val())}),$("#sc_modal_content").empty().addClass("sc_loading");var a=[];a.push({text:jse.core.lang.translate("close","buttons"),"class":"btn",click:function(){$(this).dialog("close"),$("#sc_get_quote").show()}}),a.push({text:jse.core.lang.translate("get_quotes","shipcloud"),"class":"btn btn-primary",click:b,id:"sc_get_quote"}),$("#shipcloud_modal").dialog({autoOpen:!1,modal:!0,title:jse.core.lang.translate("create_labels","shipcloud"),dialogClass:"gx-container",buttons:a,width:1e3,position:{my:"center top",at:"center bottom",of:".main-top-header"}}),$("#shipcloud_modal").dialog("open"),t.forEach(function(e){o+="orders[]="+e+"&"}),$("#sc_modal_content").load("admin.php?do=Shipcloud/CreateMultiLabelForm&"+o,h)},h=function(){$("#shipcloud_modal").dialog({title:jse.core.lang.translate("create_labels","shipcloud")}),$("#sc_modal_content").removeClass("sc_loading"),$("#sc_multi_form").on("submit",function(e){return e.preventDefault(),!1}),$("#sc_create_label").hide(),$("#sc_show_labels").hide(),$("#sc_modal_content input, #sc_modal_content select").on("change",function(){$(".sc_multi_quote").hide()}),$("#sc_package_template").on("change",a),$("input.create_label").on("click",g)},g=function(e){var t,o;return o=$(this).attr("name"),$('#sc_multi_form input[name="carrier"]').val(o),t=$("#sc_multi_form").serialize(),$("#sc_modal_content").empty().addClass("sc_loading"),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/CreateMultiLabelFormSubmit",data:t,dataType:"json"}).done(function(e){$("#sc_modal_content").removeClass("sc_loading"),"UNCONFIGURED"===e.result?d():"OK"===e.result?f(e.orders_ids,e.shipments):e.error_message&&$("#sc_modal_content").html('<div class="sc_error">'+e.error_message+"</div>")}).fail(function(e){alert(jse.core.lang.translate("submit_error","shipcloud"))}),!1},f=function(e,t){var o={orders_ids:e,shipments:t};$("#sc_modal_content").load(jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/LoadMultiLabelList",{json:JSON.stringify(o)},function(){gx.widgets.init($("#shipcloud_modal")),$("#shipcloud_modal").dialog({title:jse.core.lang.translate("labellist","shipcloud")}),$("#sc_modal_content").removeClass("sc_loading"),$("#sc_get_quote").hide(),$("form#sc_pickup").on("submit",function(e){e.preventDefault()}),jse.libs.button_dropdown.mapAction($("#sc-labellist-dropdown"),"download_labels","shipcloud",c),jse.libs.button_dropdown.mapAction($("#sc-labellist-dropdown"),"order_pickups","shipcloud",r),$("input.pickup_checkbox").on("click",i),setTimeout(i,200),$("input.pickup_checkbox_all").on("click",function(){$(this).prop("checked")===!0?($("input.pickup_checkbox").prop("checked",!0),$("input.pickup_checkbox").parent().addClass("checked")):($("input.pickup_checkbox").prop("checked",!1),$("input.pickup_checkbox").parent().removeClass("checked")),i()})})},b=function(){var e;return $("div.sc_quote").html(""),e=$("#sc_multi_form").serialize(),$.ajax({type:"POST",url:jse.core.config.get("appUrl")+"/admin/admin.php?do=Shipcloud/GetMultiShipmentQuote",data:e,dataType:"json"}).done(function(e){if("OK"===e.result){for(var t in e.shipment_quotes)$("#sc_multi_quote_"+e.shipment_quotes[t].orders_id).html(e.shipment_quotes[t].shipment_quote);$("div.sc_multi_quote").show("fast");for(var o in e.carriers_total)$("#sc_quote_"+o).html(e.carriers_total[o])}}).fail(function(e){alert(jse.core.lang.translate("submit_error","shipcloud"))}),!1};return t.init=function(e){$("body").prepend($('<div id="shipcloud_modal" title="'+jse.core.lang.translate("create_label_window_title","shipcloud")+'" style="display: none;"><div id="sc_modal_content"></div></div>'));var t=10,o=setInterval(function(){$(".js-button-dropdown").length&&(clearInterval(o),s()),0===t--&&clearInterval(o)},400);jse.libs.button_dropdown.mapAction($("#orders-table-dropdown"),"create_labels","shipcloud",m),e()},t});