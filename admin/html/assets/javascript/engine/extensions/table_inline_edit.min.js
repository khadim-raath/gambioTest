"use strict";gx.extensions.module("table_inline_edit",["form","xhr","fallback"],function(t){var e=$(this),i=null,a=null,d={multiEdit:!1},r=$.extend(!0,{},d,t),l={},n=function(t,i,a){var d=i.find("input, textarea, select, button, i"),r=d.filter(".editmode"),l=d.filter(".addmode"),n=d.filter(".defaultmode"),o=d.filter(":not(.editmode):not(.addmode):not(.defaultmode)");switch(r.hide(),l.hide(),n.hide(),i.find(".table_inlineedit_alt").remove(),t){case"edit":r.show(),o.prop("disabled",!1);break;case"add":l.show(),o.prop("disabled",!1);break;default:n.show(),o.prop("disabled",!0).each(function(){var t=$(this),e=jse.libs.fallback._data(t,"table_inline_edit");if(t.attr("type")&&"checkbox"===t.attr("type").toLowerCase()&&e.alt){var i=e.alt.split("_"),a=t.prop("checked");t.after('<span class="table_inlineedit_alt">'+(a?i[0]:i[1])+"</span>")}else if("select"===t.prop("tagName").toLowerCase()){var d=function l(){return r.hide(),t.children().length?(t.children('[value="'+t.val()+'"]').text(),void t.after('<span class="table_inlineedit_alt">'+t.children('[value="'+t.val()+'"]').text()+"</span>")):void setTimeout(function(){l()},200)};d()}})}e.trigger("FORM_UPDATE",[]),a&&i.removeClass("edit add default").addClass(t)},o=function(){var t=i.clone();t.find("[name]").each(function(){var t=$(this);t.attr("name",t.attr("name").replace("[]","[0]"))}),n("add",t,!0),jse.libs.fallback.setupWidgetAttr(t),a.append(t),gx.widgets.init(a.find("tr").last()),gx.extensions.init(a.find("tr").last()),gx.controllers.init(a.find("tr").last()),gx.compatibility.init(a.find("tr").last()),jse.widgets.init(a.find("tr").last()),jse.extensions.init(a.find("tr").last())},s=function(){var t=$(this).closest("tr"),e=JSON.stringify(t.data("formcache")),i=JSON.stringify(jse.libs.form.getData(t,void 0,!0)),a=$.Deferred(),d=function(e){e&&($("#lightbox_package_"+e.data.id+"admin_button").off(),$("#lightbox_package_"+e.data.id),$.lightbox_plugin("close",e.data.id)),e&&e.data.reject?a.reject():(t.trigger("validator.reset",[]),jse.libs.form.prefillForm(t,t.data("formcache"),!0),n("default",t,!0),a.resolve())};if(e!==i){var r="lightbox_confirm.html?section=shop_offline&amp;message=dicard_changes_hint&amp;buttons=cancel-discard",l='<a href="'+r+'"></a>',o=$(l),s=o.lightbox_plugin({lightbox_width:"360px"});$("#lightbox_package_"+s).one("click",".discard",{reject:!1,id:s},d).one("click",".cancel",{reject:!0,id:s},d)}else d();return a.promise()},c=function(){var t=$(this).closest("tr"),i=e.find("tr.edit"),a=[];!r.multiEdit&&i.length&&i.each(function(){a.push(s.call($(this).find(".row_abort").first()))}),$.when.apply(void 0,a).promise().done(function(){t.data("formcache",jse.libs.form.getData(t,void 0,!0)),n("edit",t,!0)})},f=function(){var t=$(this),i=t.closest("tr"),a=jse.libs.form.getData(i,void 0,!0),d=t.data().url,r=$.Deferred();r.done(function(){d&&(jse.core.debug.info("Sending data:",a),jse.libs.xhr.ajax({url:d,data:a})),e.trigger("row_saved",[a]),n("default",i,!0)}),i.trigger("validator.validate",[{deferred:r}])},h=function(){var t=$(this),i=t.closest("tr"),a={id:i.data("id")},d=t.data().url,r='<a href="lightbox_confirm.html?section=shop_offline&amp;message=delete_job&amp;buttons=cancel-delete"></a>',l=$(r),n=l.lightbox_plugin({lightbox_width:"360px"});$("#lightbox_package_"+n).one("click",".delete",function(){$.lightbox_plugin("close",n),d&&jse.libs.xhr.ajax({url:d,data:a}),e.trigger("row_deleted",[a]),i.remove()})},g=function(){var t=$(this),i=t.data().url,a=t.closest("tr"),d=jse.libs.form.getData(a,void 0,!0),r=$.Deferred();r.done(function(){var t=function(){e.trigger("row_added",[d]),n("default",a,!0),o()};i?(jse.core.debug.info("Sending data:",d),jse.libs.xhr.ajax({url:i,data:d}).done(function(e){var i=e.id,d=a.find("input:not(:button), textarea, select");d.each(function(){var t=$(this),e=t.attr("name").replace("[0]","["+i+"]");t.data().lightboxHref&&(t.data().lightboxHref=t.data().lightboxHref.replace("id=0","id="+i)),t.attr("name",e)}),a.find("[data-lightbox-href]").each(function(){var t=$(this).attr("data-lightbox-href").replace("id=0","id="+i);$(this).attr("data-lightbox-href",t).data().lightboxHref=t}),t()})):t()}),a.trigger("validator.validate",[{deferred:r}])},u=function(t){var i=e.filter($(t.target)).add(e.find($(t.target))).length;if(!i){var a=$(t.target).closest("tr"),d=a.hasClass("edit")?"edit":a.hasClass("add")?"add":"default";n(d,a,!0)}};return l.init=function(t){i=e.find("tfoot > tr"),a=e.children("tbody"),e.addClass("table_inlineedit"),n("default",a),o(),e.on("click",".row_edit",c).on("click",".row_delete",h).on("click",".row_save",f).on("click",".row_add",g).on("click",".row_abort",s).on("widget.initialized",u),$("body").on("validator.validate",function(t,e){e&&e.deferred&&e.deferred.resolve()}),t()},l});