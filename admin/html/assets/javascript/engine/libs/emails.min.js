"use strict";jse.libs.emails=jse.libs.emails||{},function(e){e.CONTACT_TYPE_SENDER="sender",e.CONTACT_TYPE_RECIPIENT="recipient",e.CONTACT_TYPE_REPLY_TO="reply_to",e.CONTACT_TYPE_BCC="bcc",e.CONTACT_TYPE_CC="cc",e.resetModal=function(e){e.find("input, textarea").val(""),e.find("select option:first").prop("selected","selected"),e.trigger("validator.reset"),e.find(".dataTables_wrapper").length>0&&(e.find(".dataTables_wrapper table").DataTable().clear().draw(),e.find(".dataTables_wrapper").find(".dataTables_length select option:eq(0)").prop("selected",!0)),e.find(".tab-headline-wrapper").length>0&&(e.find(".tab-headline").css("color","").show(),e.find(".tab-headline-wrapper").each(function(){$(this).find("a:eq(0)").trigger("click")})),e.find("#content-html").length>0&&(void 0!==CKEDITOR.instances["content-html"]&&CKEDITOR.instances["content-html"].destroy(),CKEDITOR.replace("content-html",{language:jse.core.config.get("languageCode")}),CKEDITOR.instances["content-html"].setData("")),e.find("#sender-type").length>0&&e.find("#sender-type").val("sender"),e.find("#recipient-type").length>0&&e.find("#recipient-type").val("recipient"),e.find("#reply-to-type").length>0&&e.find("#reply-to-type").val("reply_to"),jse.libs.emails.updateTabCounters(e)},e.getEmailFromModal=function(t){var a={};a.sender={email_address:t.find("#sender-email").val(),contact_name:t.find("#sender-name").val(),contact_type:e.CONTACT_TYPE_SENDER},a.recipient={email_address:t.find("#recipient-email").val(),contact_name:t.find("#recipient-name").val(),contact_type:e.CONTACT_TYPE_RECIPIENT},a.subject=t.find("#subject").val(),a.content_html=CKEDITOR.instances["content-html"].getData(),a.email_id=""!==t.find("#email-id").val()?t.find("#email-id").val():null,a.is_pending="true"===t.find("#is-pending").val(),a.content_plain=""!==t.find("#content-plain").val()?t.find("#content-plain").val():null,a.reply_to=""!==t.find("#reply-to-email").val()?{}:null,a.reply_to&&(a.reply_to.email_address=t.find("#reply-to-email").val(),a.reply_to.contact_name=t.find("#reply-to-name").val(),a.reply_to.contact_type=e.CONTACT_TYPE_REPLY_TO),a.bcc=null,a.cc=null;var n=t.find("#contacts-table").DataTable().rows().data();$.each(n,function(e,t){null==a[t.type]&&(a[t.type]=[]),a[t.type].push({email_address:t.email,contact_name:t.name,contact_type:t.type})}),a.attachments=null;var l=t.find("#attachments-table").DataTable().rows().data();return $.each(l,function(e,t){null===a.attachments&&(a.attachments=[]),a.attachments.push(t)}),a},e.loadEmailOnModal=function(e,t){t.find("#sender-email").val(e.sender.email_address),t.find("#sender-name").val(e.sender.contact_name),t.find("#recipient-email").val(e.recipient.email_address),t.find("#recipient-name").val(e.recipient.contact_name),t.find("#subject").val(e.subject),CKEDITOR.instances["content-html"].setData(e.content_html),t.find("#is-pending").val(e.is_pending?"true":"false"),null!==e.email_id&&t.find("#email-id").val(e.email_id),null!==e.creation_date&&t.find("#creation-date").val(e.creation_date),null!==e.sent_date&&t.find("#sent-date").val(e.sent_date),null!==e.reply_to&&(t.find("#reply-to-email").val(e.reply_to.email_address),t.find("#reply-to-name").val(e.reply_to.contact_name)),null!==e.content_plain&&t.find("#content-plain").val(e.content_plain),null!==e.bcc&&$.each(e.bcc,function(e,a){var n={email:jse.libs.normalize.escapeHtml(a.email_address),name:jse.libs.normalize.escapeHtml(a.contact_name),type:jse.libs.normalize.escapeHtml(a.contact_type)};t.find("#contacts-table").DataTable().row.add(n).draw()}),null!==e.cc&&$.each(e.cc,function(e,a){var n={email:jse.libs.normalize.escapeHtml(a.email_address),name:jse.libs.normalize.escapeHtml(a.contact_name),type:jse.libs.normalize.escapeHtml(a.contact_type)};t.find("#contacts-table").DataTable().row.add(n).draw()}),null!==e.attachments&&$.each(e.attachments,function(e,a){a.path=jse.libs.normalize.escapeHtml(a.path),t.find("#attachments-table").DataTable().row.add(a).draw()}),jse.libs.emails.updateTabCounters(t)},e.sendCollection=function(e,t){t=t||jse.core.config.get("appUrl")+"/admin/admin.php?do=Emails/Send";var a=$.Deferred(),n={pageToken:jse.core.config.get("pageToken"),collection:e};return $.post(t,n,function(e){return e.exception?void a.reject(e):void a.resolve(e)},"json"),a.promise()},e.queueCollection=function(e,t){t=t||jse.core.config.get("appUrl")+"/admin/admin.php?do=Emails/Queue";var a=$.Deferred(),n={pageToken:jse.core.config.get("pageToken"),collection:e};return $.post(t,n,function(e){return e.exception?void a.reject(e):void a.resolve(e)},"json"),a.promise()},e.deleteCollection=function(e,t){t=t||jse.core.config.get("appUrl")+"/admin/admin.php?do=Emails/Delete";var a=$.Deferred(),n={pageToken:jse.core.config.get("pageToken"),collection:e};return $.post(t,n,function(e){return e.exception?void a.reject(e):void a.resolve(e)},"json"),a.promise()},e.getDefaultModalButtons=function(e,t){var a=[{text:jse.core.lang.translate("close","buttons"),click:function(){$(this).dialog("close")}},{text:jse.core.lang.translate("queue","buttons"),click:function(){if(e.find(".tab-content.details").trigger("validator.validate"),!(e.find(".tab-content.details .error").length>0)){var a=jse.libs.emails.getEmailFromModal(e);jse.libs.emails.queueCollection([a]).done(function(e){t.DataTable().ajax.reload(),jse.libs.emails.getAttachmentsSize($("#attachments-size"))}).fail(function(e){jse.libs.modal.message({title:jse.core.lang.translate("error","messages"),content:e.message})}),$(this).dialog("close")}}},{text:jse.core.lang.translate("send","buttons"),click:function(){if(e.find(".tab-content.details").trigger("validator.validate"),!(e.find(".tab-content.details .error").length>0)){var a=jse.libs.emails.getEmailFromModal(e);jse.libs.emails.sendCollection([a]).done(function(e){t.DataTable().ajax.reload(),jse.libs.emails.getAttachmentsSize($("#attachments-size"))}).fail(function(e){jse.libs.modal.message({title:jse.core.lang.translate("error","messages"),content:e.message})}),$(this).dialog("close")}}}];return a},e.getPreviewModalButtons=function(e,t){var a=[{text:jse.core.lang.translate("close","buttons"),click:function(){$(this).dialog("close")}},{text:jse.core.lang.translate("delete","buttons"),click:function(){var a={title:"Delete Email Record",content:"Are you sure that you want to delete this email record?",buttons:[{text:jse.core.lang.translate("yes","lightbox_buttons"),click:function(){var a=jse.libs.emails.getEmailFromModal(e);jse.libs.emails.deleteCollection([a]).done(function(e){t.DataTable().ajax.reload(),jse.libs.emails.getAttachmentsSize($("#attachments-size"))}).fail(function(e){jse.libs.modal.message({title:jse.core.lang.translate("error","messages"),content:e.message})}),$(this).dialog("close"),e.dialog("close")}},{text:jse.core.lang.translate("no","lightbox_buttons"),click:function(){$(this).dialog("close")}}]};jse.libs.modal.message(a)}},{text:jse.core.lang.translate("queue","buttons"),click:function(){var a=jse.libs.emails.getEmailFromModal(e);a.is_pending||delete a.email_id,jse.libs.emails.queueCollection([a]).done(function(e){t.DataTable().ajax.reload(),jse.libs.emails.getAttachmentsSize($("#attachments-size"))}).fail(function(e){jse.libs.modal.message({title:jse.core.lang.translate("error","messages"),content:e.message})}),$(this).dialog("close")}},{text:jse.core.lang.translate("send","buttons"),click:function(){var a=jse.libs.emails.getEmailFromModal(e);jse.libs.emails.sendCollection([a]).done(function(e){t.DataTable().ajax.reload(),jse.libs.emails.getAttachmentsSize($("#attachments-size"))}).fail(function(e){jse.libs.modal.message({title:jse.core.lang.translate("error","messages"),content:e.message})}),$(this).dialog("close")}}];return a},e.colorizeButtonsForEditMode=function(e,t){$(this).closest(".ui-dialog").find(".ui-button").eq(3).addClass("btn-primary")},e.colorizeButtonsForPreviewMode=function(e,t){$(this).closest(".ui-dialog").find(".ui-button").eq(4).addClass("btn-primary")},e.deleteOldAttachments=function(e,t){t=t||jse.core.config.get("appUrl")+"/admin/admin.php?do=Emails/DeleteOldAttachments";var a=$.Deferred(),n={pageToken:jse.core.config.get("pageToken"),removalDate:e};return $.post(t,n,function(e){return e.exception?void a.reject(e):void a.resolve(e)},"json"),a.promise()},e.getAttachmentsSize=function(e,t){t=t||jse.core.config.get("appUrl")+"/admin/admin.php?do=Emails/GetAttachmentsSize";var a=$.Deferred();return $.get(t,function(t){if(t.exception)return jse.libs.modal.message({title:jse.core.lang.translate("error","messages"),content:t.message}),void a.reject(t);var n=0!==t.size.megabytes?t.size.megabytes+" MB":t.size.bytes+" bytes";e.text("("+n+")"),a.resolve(t)},"json"),a.promise()},e.updateTabCounters=function(e,t,a,n,l){if(t=t||e.find("#contacts-table"),a=a||e.find(".tab-headline.bcc-cc"),n=n||e.find("#attachments-table"),l=l||e.find(".tab-headline.attachments"),0!==t.length){var i=t.DataTable().rows().data().length,s=a.text().replace(/\(.*\)/g,"("+i+")"),o=n.DataTable().rows().data().length,c=l.text().replace(/\(.*\)/g,"("+o+")");s.indexOf("(")===-1&&(s+=" ("+i+")"),c.indexOf("(")===-1&&(c+=" ("+o+")"),a.text(s),l.text(c)}},e.getSelectedEmails=function(e){e=e||$("#emails-table");var t=[];return e.find("tr td input:checked").each(function(e,a){t.push($(a).parents("tr").data())}),t}}(jse.libs.emails);