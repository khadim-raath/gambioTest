function unfold_category(e){var s=$("#csv_scheme_id",t_lightbox_package).val(),c=$(e).attr("rel"),_=$(e).attr("href");$(e).hasClass("csv_fold")?$(e).hasClass("loaded")?($(e).removeClass("csv_fold"),$(e).addClass("csv_unfold"),$(e).parent().children("ul.subtree").show()):(window.csv_form_changed|=$("#csv_categories_form",t_lightbox_package).form_changes_checker(),$.ajax({type:"GET",url:"request_port.php?module=CSV&action=get_template",timeout:1e4,dataType:"json",context:e,data:{scheme_id:s,template:_,categories_id:c},success:function(e){$(this).removeClass("csv_fold"),$(this).addClass("csv_unfold"),$(this).addClass("loaded"),$(this).parent().children("ul.subtree").append(e.html);var s=get_inherited_state($(this).parent().children("ul.subtree"));s&&$(this).parent().children("ul.subtree").children().children("a.checkbox").each(function(){set_checkbox_state(this,s)}),$("#csv_categories_form",t_lightbox_package).form_changes_checker("initialize")},error:function(e,s){$.lightbox_plugin("error",t_lightbox_identifier,e,s)}})):($(e).removeClass("csv_unfold"),$(e).addClass("csv_fold"),$(e).parent().children("ul.subtree").hide())}function click_checkbox(e){var s=is_checked(e)?"no_self_no_sub_checked":"self_all_sub_checked",c=$(e).parent().children("a.csv_category_link").hasClass("loaded"),_=$(e).parent().children("a.csv_category_link").hasClass("csv_fold"),a=add_checkbox_state(e,s);$(e).parent().children("input.hidden_input").val(a.substring(0,a.lastIndexOf("_"))),_&&($(e).removeClass("pass_on_no_self_no_sub_checked"),$(e).removeClass("pass_on_self_all_sub_checked"),$(e).addClass("pass_on_"+s),c&&check_children(e,s)),mark_parents(e),"self_all_sub_checked"!=s&&$("#csv_select_all_categories").is(":checked")?$("#csv_select_all_categories").prop("checked",!1):$("a.checkbox").size()!=$("a.checkbox.self_all_sub_checked").size()||$("#csv_select_all_categories").is(":checked")||$("#csv_select_all_categories").prop("checked",!0)}function check_children(e,s){var c=$(e).parent().children("ul.subtree").children().children("a.checkbox");c.size()>0&&c.each(function(){set_checkbox_state(this,s),check_children(this,s)})}function mark_parents(e){var s=$(e).parent().parent();if(s.hasClass("subtree")){var c=s.parent().children("a.checkbox");mark_category(c),mark_parents(c)}}function mark_category(e){var s=is_checked(e),c=$(e).parent().children("ul.subtree").children().children("a.checkbox"),_=c.length,a=0,t=csv_default;c.each(function(){$(this).hasClass("no_self_no_sub_checked")||a++,$(this).hasClass("self_all_sub_checked")||_++}),s?a==_?t="self_all_sub_checked":a>0?t="self_some_sub_checked":0==a&&(t="self_no_sub_checked"):a==_?t="no_self_all_sub_checked":a>0?t="no_self_some_sub_checked":0==a&&(t="no_self_no_sub_checked"),set_checkbox_state(e,t)}function add_checkbox_state(e){var s=get_checkbox_state(e),c=csv_default;if($(e).parent().children("a.csv_category_link").hasClass("csv_fold")||$(e).parent().children("a.csv_category_link").hasClass("csv_unfold")&&0==get_child_count(e))switch(s){case"self_all_sub_checked":case"self_some_sub_checked":case"self_no_sub_checked":c="no_self_no_sub_checked";break;case"no_self_all_sub_checked":case"no_self_some_sub_checked":case"no_self_no_sub_checked":c="self_all_sub_checked"}else switch(s){case"self_all_sub_checked":c="no_self_all_sub_checked";break;case"self_some_sub_checked":c="no_self_some_sub_checked";break;case"self_no_sub_checked":c="no_self_no_sub_checked";break;case"no_self_all_sub_checked":c="self_all_sub_checked";break;case"no_self_some_sub_checked":c="self_some_sub_checked";break;case"no_self_no_sub_checked":c="self_no_sub_checked"}return set_checkbox_state(e,c),c}function set_checkbox_state(e,s){reset_checkbox(e),$(e).addClass(s),$(e).parent().children("input.hidden_input").val(s.substring(0,s.lastIndexOf("_")))}function reset_checkbox(e){for(var s=0;s<csv_checkbox_states.length;s++)$(e).removeClass(csv_checkbox_states[s])}function get_checkbox_state(e){for(var s=0;s<csv_checkbox_states.length;s++)if($(e).hasClass(csv_checkbox_states[s]))return csv_checkbox_states[s];return csv_default}function extract_categories_id(e){return e.substring(e.lastIndexOf("_")+1)}function assoc_array_to_string(e){var s="";for(var c in e)s+=c+"="+e[c]+",";return s=s.substring(0,s.length-1)}function is_checked(e){return $(e).hasClass("self_all_sub_checked")||$(e).hasClass("self_some_sub_checked")||$(e).hasClass("self_no_sub_checked")}function get_child_count(e){return $(e).parent().children("ul.subtree").children().size()}function get_inherited_state(e){for(var s=$(e);s.hasClass("subtree");){if(s.parent().children("a.checkbox").hasClass("pass_on_no_self_no_sub_checked"))return"no_self_no_sub_checked";if(s.parent().children("a.checkbox").hasClass("pass_on_self_all_sub_checked"))return"self_all_sub_checked";s=s.parent().parent()}return!1}var csv_checkbox_states=["self_all_sub_checked","self_some_sub_checked","self_no_sub_checked","no_self_all_sub_checked","no_self_some_sub_checked","no_self_no_sub_checked"],csv_default="no_self_no_sub_checked";window.csv_form_changed=!1,$(t_lightbox_package).delegate("a.btn.save","click",function(){if($(this).hasClass("active"))return!1;if(1==$("#csv_categories",t_lightbox_package).length){$(this).addClass("active");var e=$("#csv_scheme_id",t_lightbox_package).val(),s=$("#csv_select_all_categories",t_lightbox_package).is(":checked"),c=new Array,_=new Array,a="",t="";if(!s){var l="a.checkbox";$(l).each(function(){var e=get_checkbox_state(this);e=e.substring(0,e.lastIndexOf("_")),c[extract_categories_id(this.id)]=e}),a=assoc_array_to_string(c),l="a.pass_on_no_self_no_sub_checked, a.pass_on_self_all_sub_checked",$(l).each(function(){var e="self_all_sub";$(this).hasClass("pass_on_no_self_no_sub_checked")&&(e="no_self_no_sub"),_[extract_categories_id(this.id)]=e}),t=assoc_array_to_string(_)}$.ajax({type:"POST",url:"request_port.php?module=CSV&action=save_categories",timeout:1e4,dataType:"json",context:this,data:{scheme_id:e,selected_categories:a,bequeathing_categories:t,select_all:s},success:function(e){$(this).removeClass("active"),$("form",t_lightbox_package).form_changes_checker("initialize",!1),window.csv_form_change=!1},error:function(e,s){$.lightbox_plugin("error",t_lightbox_identifier,e,s)}})}return!1}),$(t_lightbox_package).delegate("a.checkbox","click",function(){return click_checkbox(this),!1}),$(t_lightbox_package).delegate("a.checkbox","keydown",function(e){return 32!=e.keyCode||(e.preventDefault(),click_checkbox(this),!1)}),$(t_lightbox_package).delegate("a.csv_category_link","click",function(){return unfold_category(this),!1}),$(t_lightbox_package).delegate("a.csv_category_link","keydown",function(e){return 32!=e.keyCode||(e.preventDefault(),unfold_category(this),!1)}),$(t_lightbox_package).delegate("#csv_select_all_categories","change",function(){var e=$(this).is(":checked")?"self_all_sub_checked":"no_self_no_sub_checked",s=$(this).is(":checked")?"pass_on_self_all_sub_checked":"pass_on_no_self_no_sub_checked";return $("a.checkbox").each(function(){set_checkbox_state(this,e),$(this).removeClass("pass_on_self_all_sub_checked"),$(this).removeClass("pass_on_no_self_no_sub_checked"),$(this).addClass(s)}),!0});